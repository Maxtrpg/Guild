<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAZTICA | å†’éšªè€…å…¬æœƒ</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Crimson+Pro:ital,wght@0,400;0,700;1,400&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --font-title: 'Cinzel', serif;
            --font-body: 'Inter', sans-serif;
            --font-hand: 'Crimson Pro', serif;
            --private-bg-image: url('https://nlhqslyecdmwqdrtluki.supabase.co/storage/v1/object/public/BG/01.webp'), radial-gradient(circle at 50% 10%, rgba(255, 160, 80, 0.15), rgba(0,0,0,0.8));
            --private-bg-color: #2c1e14;
        }

        body { 
            margin: 0; padding: 0; 
            min-height: 100vh; 
            overflow-x: hidden; 
            font-family: var(--font-body); 
            transition: background 0.5s ease; 
            background-attachment: fixed; background-size: cover; background-position: center; background-color: #000;
        }
        * { box-sizing: border-box; transition: border-color 0.2s, background-color 0.2s, color 0.2s; }

        /* Security */
        body:not(.authenticated) header,
        body:not(.authenticated) .view-container,
        body:not(.authenticated) #chat-widget,
        body:not(.authenticated) #npc-intro-layer { display: none !important; }
        body.authenticated #login-gate { display: none !important; }
        .hidden { display: none !important; }

        /* Modes */
        body.mode-guild {
            background-image: url('https://nlhqslyecdmwqdrtluki.supabase.co/storage/v1/object/public/BG/bg-guild02.webp');
            color: #e0e0e0;
            --panel-bg: rgba(20, 20, 20, 0.95);
            --border-color: #444;
            --highlight: #d4af37;
            --input-bg: rgba(0,0,0,0.6);
            --input-text: #eee;
            --btn-bg: linear-gradient(to bottom, #d4af37, #8c6b22);
            --btn-text: #000;
            --tab-active-bg: rgba(212, 175, 55, 0.2);
            --list-item-bg: rgba(255,255,255,0.05);
            --btn-add-border: #d4af37;
            --btn-add-hover: #d4af37;
            --btn-add-text-hover: #000;
        }
        
        body.mode-guild::before { content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.5)); pointer-events: none; z-index: 0; }
        body.mode-guild::after { content: ''; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%; background: radial-gradient(circle at 50% 50%, rgba(255, 215, 0, 0.05), transparent 40%); animation: lightShift 15s infinite alternate ease-in-out; pointer-events: none; z-index: 0; mix-blend-mode: screen; }
        @keyframes lightShift { 0% { transform: translate(0,0); opacity: 0.5; } 100% { transform: translate(-20px, 20px); opacity: 0.8; } }

        body.mode-private {
            color: var(--p-text-main, #f3e5dc);
            --panel-bg: var(--p-panel-bg, rgba(40, 30, 25, 0.95));
            --border-color: var(--p-border-color, #8d6e63);
            --highlight: var(--p-highlight, #ffb74d);
            --input-bg: rgba(0, 0, 0, 0.4); 
            --input-text: #f0f0f0; 
            --btn-bg: var(--p-btn-bg, linear-gradient(to bottom, #ffb74d, #e65100));
            --btn-text: var(--p-btn-text, #2e1500);
            --tab-active-bg: rgba(255, 183, 77, 0.2);
            --list-item-bg: rgba(0,0,0,0.5); 
            --btn-add-border: #ffb74d;
            --btn-add-hover: #ffb74d;
            --btn-add-text-hover: #2e1500;
        }

        /* Header */
        header { position: sticky; top: 0; z-index: 100; background: rgba(10, 5, 0, 0.95); border-bottom: 2px solid var(--highlight); padding: 8px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 5px 20px rgba(0,0,0,0.8); }
        .brand { font-family: var(--font-title); font-size: 1.4rem; font-weight: 700; color: var(--highlight); letter-spacing: 2px; }
        .mode-switch { display: flex; background: rgba(255,255,255,0.05); border-radius: 30px; border: 1px solid var(--border-color); padding: 2px; gap: 5px; }
        .mode-btn { background: transparent; border: none; color: #888; padding: 4px 12px; border-radius: 20px; cursor: pointer; font-family: var(--font-title); font-size: 0.8rem; }
        .mode-btn.active { background: var(--highlight); color: var(--btn-text); font-weight: bold; }
        .btn-logout { background: none; border: 1px solid var(--border-color); color: #888; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .btn-logout:hover { color: var(--highlight); border-color: var(--highlight); }

        /* Controls */
        .controls-wrapper { display: flex; justify-content: center; align-items: center; gap: 20px; padding: 8px 0; background: rgba(0,0,0,0.3); border-bottom: 1px solid rgba(255,255,255,0.05); position: relative; z-index: 2; }
        .nav-container { display: flex; gap: 5px; margin: 0; }
        .nav-btn { background: var(--panel-bg); border: 1px solid var(--border-color); color: #888; padding: 5px 15px; border-radius: 4px; cursor: pointer; font-family: var(--font-title); font-size: 0.85rem; transform: skewX(-15deg); }
        .nav-btn span { display: block; transform: skewX(15deg); font-weight: bold; }
        .nav-btn.active { background: rgba(255,255,255,0.1); border-color: var(--highlight); color: var(--highlight); }
        .theme-bar { display: flex; gap: 8px; margin: 0; background: transparent; padding: 0; border: none; }
        .theme-btn { width: 22px; height: 22px; border-radius: 50%; border: 2px solid #555; cursor: pointer; transition: 0.2s; display: flex; justify-content: center; align-items: center; color: #fff; font-size: 0.7rem; background: rgba(0,0,0,0.5); }
        .theme-btn:hover { transform: scale(1.2); border-color: #fff; }
        .theme-btn.active { border-color: #fff; transform: scale(1.2); box-shadow: 0 0 8px #fff; }
        .t-scholar { background: #5d4037; } .t-warrior { background: #37474f; } .t-jungle { background: #1b5e20; } .t-tavern { background: #e65100; }

        /* Main Layout */
        main { max-width: 1200px; margin: 0 auto; padding: 0 15px 80px; position: relative; z-index: 1; }
        .view-container { display: none; opacity: 0; transition: opacity 0.4s ease; }
        .view-container.active { display: block; opacity: 1; }
        .section { display: none; animation: slideUp 0.3s forwards; }
        .section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Reception */
        .reception-area { display: flex; align-items: center; justify-content: center; gap: 30px; padding: 30px; margin-bottom: 20px; background: linear-gradient(90deg, transparent 0%, rgba(0,0,0,0.4) 50%, transparent 100%); border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); }
        
        /* Chat Widget */
        #chat-widget { position: fixed; bottom: 30px; right: 30px; z-index: 8000; display: flex; flex-direction: column; align-items: flex-end; }
        #npc-chat-toggle { width: 90px; height: 90px; border-radius: 50%; border: 3px solid #ffecb3; box-shadow: 0 0 0 4px #1a1a1a, 0 0 0 7px #d4af37, 0 5px 20px rgba(0,0,0,0.8), 0 0 30px rgba(212,175,55,0.4); cursor: pointer; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); position: relative; background: #000; overflow: hidden; }
        #npc-chat-toggle:hover { transform: scale(1.1); box-shadow: 0 0 0 4px #1a1a1a, 0 0 0 7px #fff, 0 0 40px rgba(212,175,55,0.8); }
        #npc-chat-img { width: 100%; height: 100%; object-fit: cover; }
        #chat-notify { position: absolute; top: 0; right: 0; width: 20px; height: 20px; background: #ff4444; border-radius: 50%; border: 2px solid #fff; display: none; animation: pulse-red 2s infinite; text-align: center; color: white; font-size: 12px; line-height: 16px; font-weight: bold; }
        @keyframes pulse-red { 0%{box-shadow:0 0 0 0 rgba(255,68,68,0.7)} 70%{box-shadow:0 0 0 10px rgba(255,68,68,0)} 100%{box-shadow:0 0 0 0 rgba(255,68,68,0)} }
        #chat-box { width: 350px; height: 450px; background: rgba(15, 10, 5, 0.95); border: 1px solid var(--highlight); border-radius: 12px; margin-bottom: 15px; display: none; flex-direction: column; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.8); backdrop-filter: blur(10px); transform-origin: bottom right; animation: popOpen 0.3s; }
        @keyframes popOpen { from{transform:scale(0);opacity:0;} to{transform:scale(1);opacity:1;} }
        .chat-header { padding: 15px; background: rgba(var(--highlight), 0.1); border-bottom: 1px solid rgba(255,255,255,0.1); color: var(--highlight); font-weight: bold; font-family: var(--font-title); display: flex; align-items: center; gap: 10px; }
        .chat-header img { width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--highlight); }
        .chat-body { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .chat-msg { font-size: 0.9rem; padding: 8px 12px; border-radius: 8px; max-width: 85%; word-wrap: break-word; display: flex; gap: 10px; align-items: flex-end; }
        .chat-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; border: 1px solid #aaa; flex-shrink: 0; }
        .msg-npc { align-self: flex-start; background: rgba(255,255,255,0.1); color: #ddd; border-left: 3px solid var(--highlight); flex-direction: row; }
        .msg-player { align-self: flex-end; background: var(--highlight); color: #000; border-radius: 8px 8px 0 8px; flex-direction: row-reverse; }
        .chat-footer { padding: 10px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; gap: 5px; flex-direction: column; }
        .chat-input-row { display: flex; gap: 5px; }
        #chat-in { margin: 0; width: 100%; border-radius: 20px; padding: 8px 12px; background: rgba(0,0,0,0.3); border: 1px solid #555; color: #fff; }
        #chat-send { background: transparent; border: none; color: var(--highlight); cursor: pointer; font-size: 1.2rem; }

        /* NPC Intro */
        #npc-intro-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); z-index: 9000; display: none; flex-direction: column; justify-content: flex-end; align-items: center; }
        #npc-intro-layer.active { display: flex; animation: fadeInOverlay 0.5s forwards; }
        .npc-full-body { height: 80vh; max-height: 800px; width: auto; position: absolute; bottom: -50px; left: 10%; filter: drop-shadow(0 0 20px rgba(0,0,0,0.8)); transform: translateY(100%); animation: slideInUp 0.8s 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; pointer-events: none; }
        .npc-dialogue-ui { width: 90%; max-width: 800px; background: rgba(20, 20, 20, 0.95); border: 2px solid var(--highlight); border-radius: 10px; padding: 25px; margin-bottom: 50px; box-shadow: 0 0 50px rgba(0,0,0,0.8), 0 0 15px rgba(212,175,55,0.3); position: relative; z-index: 9001; cursor: pointer; opacity: 0; animation: fadeInUI 0.5s 0.8s forwards; }
        .npc-dialogue-ui::after { content: 'â–¼'; position: absolute; bottom: 10px; right: 20px; color: var(--highlight); animation: bounce 1s infinite; }
        .npc-label { position: absolute; top: -20px; left: 30px; background: var(--highlight); color: #000; padding: 5px 20px; font-family: var(--font-title); font-weight: bold; border-radius: 4px; border: 2px solid #fff; transform: skewX(-15deg); }
        .typewriter-text { font-family: var(--font-hand); font-size: 1.3rem; color: #eee; line-height: 1.6; min-height: 60px; }
        @keyframes slideInUp { to { transform: translateY(0); } } @keyframes fadeInOverlay { from { opacity:0; } to { opacity:1; } } @keyframes fadeInUI { from { opacity:0; transform:translateY(20px); } to { opacity:1; transform:translateY(0); } } @keyframes bounce { 0%, 100% { transform:translateY(0); } 50% { transform:translateY(5px); } }

        /* Buttons & Forms */
        .btn-action { width: 100%; padding: 10px; margin-top: 10px; background: var(--btn-bg); color: var(--btn-text); font-weight: bold; border: none; border-radius: 4px; font-family: var(--font-title); cursor: pointer; text-transform: uppercase; }
        .btn-action:hover { filter: brightness(1.2); }
        .btn-add { margin-top: 8px; padding: 6px 12px; font-size: 0.85rem; background: rgba(0,0,0,0.6); border: 1px solid var(--btn-add-border); color: var(--btn-add-border); border-radius: 4px; cursor: pointer; font-weight: bold; text-transform: uppercase; display: inline-block; transition: 0.2s; }
        .btn-add:hover { background: var(--btn-add-hover); color: var(--btn-add-text-hover); box-shadow: 0 0 10px var(--btn-add-border); }

        /* Editor */
        .forge-wrapper { display: flex; gap: 20px; height: 80vh; align-items: flex-start; position: relative; padding-top: 10px; }
        @media (max-width: 900px) { .forge-wrapper { flex-direction: column; } }
        .char-list-sidebar { width: 220px; min-width: 220px; flex-shrink: 0; background: rgba(0,0,0,0.5); border: 1px solid var(--border-color); border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; position: sticky; top: 70px; max-height: calc(100vh - 90px); }
        .char-list-header { padding: 10px; background: rgba(255,255,255,0.05); border-bottom: 1px solid var(--border-color); text-align: center; color: var(--highlight); font-weight: bold; }
        .char-list-content { flex: 1; overflow-y: auto; padding: 5px; }
        .char-list-item { padding: 8px; cursor: pointer; color: #aaa; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .char-list-item:hover, .char-list-item.active { background: var(--highlight); color: var(--btn-text); font-weight: bold; }
        .btn-new-char { width:100%; padding:10px; background:rgba(0,0,0,0.3); border:none; border-top:1px solid var(--border-color); color:var(--highlight); font-weight:bold; cursor:pointer; }
        .btn-new-char:hover { background:rgba(255,255,255,0.1); }
        .editor-main { flex: 1; width: 100%; } 
        .editor-layout { display: grid; grid-template-columns: 280px 1fr; gap: 20px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); padding: 20px; border-radius: 8px; }
        @media (max-width: 1100px) { .editor-layout { grid-template-columns: 1fr; } }
        .editor-left { display: flex; flex-direction: column; gap: 15px; }
        .avatar-upload-wrapper { position: relative; width: 100%; aspect-ratio: 2/3; background: #000; border: 2px solid var(--highlight); border-radius: 6px; overflow: hidden; cursor: pointer; }
        .avatar-img { width: 100%; height: 100%; object-fit: cover; }
        .avatar-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; justify-content:center; align-items:center; opacity:0; color:#fff; font-size:2rem; transition:0.3s; }
        .avatar-upload-wrapper:hover .avatar-overlay { opacity:1; }
        .editor-tabs { display: flex; gap: 5px; border-bottom: 2px solid var(--border-color); margin-bottom: 15px; flex-wrap: wrap; }
        .editor-tab { padding: 8px 15px; background: rgba(0,0,0,0.4); color: #888; border: none; border-radius: 4px 4px 0 0; cursor: pointer; font-family: var(--font-title); font-size: 0.9rem; flex: 1; text-align: center; transition: 0.2s; min-width: 80px; }
        .editor-tab:hover { background: rgba(255,255,255,0.1); color: #ccc; }
        .editor-tab.active { background: var(--tab-active-bg); color: var(--highlight); border: 1px solid var(--highlight); border-bottom: none; font-weight: bold; }
        .editor-panel { display: none; animation: fadeIn 0.3s; }
        .editor-panel.active { display: block; }
        .game-input { width: 100%; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--input-text); padding: 8px; border-radius: 4px; font-weight: 600; font-size: 0.95rem; }
        .game-textarea { width: 100%; background: var(--input-bg); border: 1px solid var(--border-color); color: var(--input-text); padding: 8px; border-radius: 4px; resize: vertical; font-family: inherit; }
        .editor-label { display: block; font-size: 0.7rem; color: #aaa; text-transform: uppercase; margin: 10px 0 2px 0; border-bottom: 1px dashed #666; font-weight: bold; }
        .attr-hex-grid { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 10px; }
        .attr-hex { width: 60px; text-align: center; }
        .attr-hex input { text-align: center; font-family: var(--font-title); font-size: 1.2rem; font-weight: bold; color: var(--highlight); background: rgba(0,0,0,0.5); padding: 5px; }
        .currency-row { display: flex; gap: 5px; margin-top: 5px; }
        .curr-box { flex:1; text-align: center; background: rgba(0,0,0,0.3); padding: 3px; border-radius: 4px; border: 1px solid var(--border-color); }
        .curr-label { font-size: 0.6rem; color: var(--text-sub); margin-bottom: 2px; }
        .curr-input { width: 100%; text-align: center; background: transparent; border: none; color: var(--text-main); font-weight: bold; font-family: var(--font-title); font-size: 1rem; }
        .editor-list-box { background: rgba(0,0,0,0.3); border: 1px solid var(--border-color); padding: 8px; border-radius: 4px; max-height: 250px; overflow-y: auto; margin-bottom: 5px; }
        .item-row-edit { display: flex; gap: 8px; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 6px; margin-bottom: 4px; background: var(--list-item-bg); border-radius: 4px; }
        .item-row-edit input { background: transparent; border: none; color: #fff; width: 100%; font-weight: 500; font-size: 0.95rem; text-shadow: 0 1px 2px #000; }
        .item-row-edit input.qty-input { width: 40px; text-align: center; border-left: 1px solid rgba(255,255,255,0.2); }
        .item-row-edit input:focus { color: var(--highlight); }
        .btn-icon { background: none; border: none; color: #ef5350; cursor: pointer; font-size: 1rem; }
        .json-zone { border: 2px dashed var(--border-color); padding: 15px; text-align: center; color: #888; border-radius: 8px; cursor: pointer; margin-bottom: 15px; background: rgba(0,0,0,0.1); font-size: 0.9rem; }
        .json-zone:hover { border-color: var(--highlight); color: var(--highlight); }

        /* Parchment Cards */
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; padding-bottom:20px; }
        .card { background: var(--panel-bg); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; position: relative; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .card h3 { color: var(--highlight); margin: 0 0 10px 0; font-family: var(--font-title); font-size: 1.2rem; }
        
        .parchment-base { background-color: #f7f1e3; background-image: url('https://www.transparenttextures.com/patterns/parchment.png'); border: 1px solid #8d6e63; box-shadow: 0 5px 15px rgba(0,0,0,0.3); color: #3e2723; font-family: var(--font-hand); border-radius: 2px; transition: 0.3s; }
        .parchment-base:hover { transform: scale(1.01); z-index: 5; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .card-quest { background-color: #f7f1e3; background-image: url('https://www.transparenttextures.com/patterns/parchment.png'); border: 1px solid #8d6e63; box-shadow: 0 5px 15px rgba(0,0,0,0.3); color: #3e2723; padding: 0; overflow:hidden; font-family: var(--font-hand); }
        .quest-header { display: flex; align-items: center; gap: 10px; background: rgba(141, 110, 99, 0.15); padding: 12px 20px; border-bottom: 1px dashed #8d6e63; }
        .quest-client-img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid #5d4037; filter: sepia(0.3); }
        .quest-client-name { font-weight: bold; font-family: var(--font-title); font-size: 1rem; color: #3e2723; }
        .quest-body { padding: 20px; }
        .quest-title { font-family: var(--font-title); font-size: 1.5rem; font-weight: 900; margin-bottom: 10px; text-transform: uppercase; color: #b71c1c; letter-spacing: 1px; }
        .quest-desc { font-size: 1.15rem; line-height: 1.6; color: #4e342e; }
        .quest-footer { background: rgba(183, 28, 28, 0.05); padding: 12px; text-align: center; border-top: 2px double #b71c1c; color: #b71c1c; font-weight: bold; font-family: var(--font-title); font-size: 1.1rem; display: flex; justify-content: space-between; align-items: center; }

        .card-market { background-color: #efdcd5; background-image: url('https://www.transparenttextures.com/patterns/lined-paper-2.png'); border: 1px solid #8d6e63; padding: 0; overflow:hidden; color: #3e2723; font-family: var(--font-hand); }
        .market-header { display: flex; align-items: center; gap: 10px; background: rgba(93, 64, 55, 0.1); padding: 10px 15px; border-bottom: 1px solid #8d6e63; }
        .market-seller-img { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 1px solid #5d4037; }
        .market-seller-name { color: #5d4037; font-size: 0.9rem; font-weight: bold; }
        .market-body { padding: 15px; text-align: center; }
        .market-item { color: #bf360c; font-family: var(--font-title); font-size: 1.4rem; margin-bottom: 5px; font-weight: bold; }
        .market-desc { color: #5d4037; font-size: 1rem; font-style: italic; }
        .market-footer { background: rgba(62, 39, 35, 0.1); padding: 8px; text-align: center; color: #3e2723; font-weight: bold; border-top: 1px dashed #8d6e63; font-family: var(--font-title); }
        
        .card-notice { background-color: #fff8e1; background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png'); border: 4px double #5d4037; padding: 25px; position: relative; color: #3e2723; }
        .card-notice::before { content:'â™”'; position:absolute; top:5px; right:15px; font-size:4rem; color:#8a0303; opacity:0.1; }
        .card-notice h3 { color: #b71c1c; font-family: var(--font-title); margin-bottom: 15px; border-bottom: 1px solid #5d4037; padding-bottom: 10px; font-size: 1.4rem; }
        .card-notice .desc { color: #3e2723; font-family: var(--font-hand); font-size: 1.2rem; line-height: 1.6; }

        .roster-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        .party-card { background: linear-gradient(135deg, rgba(20,20,20,0.9), rgba(40,40,40,0.9)); border: 2px solid var(--border-color); border-radius: 8px; padding: 20px; text-align: center; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; }
        .party-card:hover { transform: translateY(-5px); border-color: var(--highlight); box-shadow: 0 0 20px rgba(212,175,55,0.2); }
        .party-icon { font-size: 2.5rem; color: var(--highlight); margin-bottom: 10px; }
        .party-icon-img { width: 150px; height: 150px; object-fit: cover; border-radius: 50%; margin-bottom: 10px; border: 2px solid var(--highlight); }
        .party-name { font-family: var(--font-title); font-size: 1.4rem; color: #fff; margin-bottom: 5px; }
        .party-count { color: #888; font-size: 0.9rem; font-family: var(--font-hand); font-style: italic; }
        .party-slogan { color: var(--highlight); font-size: 0.95rem; margin-bottom: 5px; font-family: var(--font-hand); min-height: 1.2em; }
        .char-row { display: flex; align-items: center; gap: 15px; background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px; }
        .char-row img { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 2px solid var(--highlight); }
        .member-preview-icon { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 1px solid #aaa; }

        /* Status Tags */
        .status-tag { padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; font-weight: bold; border: 1px solid #333; cursor:pointer; }
        .st-open { background: #2e7d32; color: #fff; }
        .st-taken { background: #f9a825; color: #000; }
        .st-done { background: #424242; color: #ccc; }

        /* Comments */
        .comment-section { display: none; background: rgba(0,0,0,0.05); margin-top: 10px; padding: 10px; border-top: 1px dashed #8d6e63; }
        .comment-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: flex-start; text-align: left; }
        .comment-avatar { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; border: 1px solid #8d6e63; }
        .comment-content { background: rgba(255,255,255,0.5); padding: 5px 10px; border-radius: 8px; font-size: 0.9rem; }
        .comment-author { font-weight: bold; font-size: 0.8rem; color: #5d4037; }

        /* Iframe Styles for Library */
        #library-iframe-wrapper { max-width: 1000px; margin: 20px auto; border: 1px solid #5d4037; border-radius: 8px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        #library-iframe { width: 100%; height: 90vh; display: block; }
        
        /* Modals */
        #login-gate { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 320px; background: #111; padding: 30px; border: 2px solid var(--highlight); text-align: center; z-index: 2000; border-radius: 10px; }
        .modal-overlay { position: fixed !important; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); backdrop-filter: blur(5px); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .modal-overlay.open { display: flex !important; }
        .modal-content { background: #151515; border: 1px solid var(--highlight); width: 95%; max-width: 700px; padding: 25px; border-radius: 8px; position: relative; max-height: 90vh; overflow-y: auto; margin: auto; }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; color: #888; cursor: pointer; }
        #toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #222; border: 1px solid var(--highlight); color: var(--highlight); padding: 8px 20px; display: none; z-index: 4000; border-radius: 20px; }
        
        /* Game Specific */
        .adv-row { display: flex; gap: 10px; align-items: center; margin-bottom: 5px; }
        .adv-row select, .adv-row input { background: rgba(0,0,0,0.5); border: 1px solid #444; color: #ccc; padding: 5px; border-radius: 4px; font-size: 0.9rem; }
        .adv-row select { flex: 2; } .adv-row input { flex: 3; }
        .adv-add-btn { background: #333; border: 1px solid #555; color: #ccc; cursor: pointer; padding: 5px 10px; margin-top: 5px; font-size: 0.8rem; }
        .game-tabs { display: flex; gap: 5px; border-bottom: 2px solid var(--border-color); margin-bottom: 15px; flex-wrap: wrap; }
        .game-tab { padding: 8px 15px; background: rgba(0,0,0,0.3); color: #888; border: 1px solid transparent; border-bottom: none; border-radius: 4px 4px 0 0; cursor: pointer; font-family: var(--font-title); font-size: 0.9rem; flex: 1; text-align: center; transition: 0.2s; }
        .game-tab.active { background: rgba(255,255,255,0.1); color: var(--highlight); border-color: var(--highlight); font-weight: bold; }
        .game-panel { display: none; height: 400px; overflow-y: auto; padding-right: 5px; animation: fadeIn 0.2s; }
        .game-panel.active { display: block; }
        .char-sheet-game { display: grid; grid-template-columns: 250px 1fr; gap: 20px; }
        .char-portrait-frame { width: 100%; aspect-ratio: 2/3; border: 3px solid var(--highlight); border-radius: 8px; overflow: hidden; background: #000; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .hex-stat-display { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 15px; }
        .hex-box { width: 60px; height: 70px; background: #1a1a1a; border: 1px solid #444; display: flex; flex-direction: column; align-items: center; justify-content: center; clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); }
        .hex-val { font-size: 1.4rem; font-weight: bold; color: var(--highlight); font-family: var(--font-title); }
        .char-right { display: flex; flex-direction: column; gap: 15px; }
        .game-item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px; }
        .game-item-slot { width: 100%; aspect-ratio: 1/1; background: rgba(0,0,0,0.4); border: 2px solid var(--border-color); border-radius: 6px; position: relative; cursor: pointer; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        .game-item-slot:hover { border-color: var(--highlight); transform: scale(1.05); }
        .game-item-img { width: 100%; height: 100%; object-fit: cover; }
        .game-item-fallback { font-size: 1.5rem; color: #555; }
        .game-item-slot:hover .game-item-fallback { color: var(--highlight); }
        .item-modal-layout { display: grid; grid-template-columns: 100px 1fr; gap: 20px; }
        .item-modal-icon-box { width: 100px; height: 100px; border: 2px solid var(--highlight); border-radius: 12px; overflow: hidden; background: #000; display: flex; justify-content: center; align-items: center; box-shadow: 0 0 20px rgba(212,175,55,0.2); }
        .item-modal-img { width: 100%; height: 100%; object-fit: cover; }
        .item-modal-fallback { font-size: 3rem; color: var(--highlight); }
        .item-modal-header h3 { margin: 0 0 5px 0; color: var(--highlight); font-family: var(--font-title); font-size: 1.5rem; }
        .item-modal-type { color: var(--text-sub); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 1px; }
        .item-modal-desc { margin-top: 20px; font-size: 0.95rem; line-height: 1.6; color: #ccc; border-top: 1px solid var(--border-color); padding-top: 15px; max-height: 200px; overflow-y: auto; }
        @media(max-width:900px){.char-sheet-game{grid-template-columns:1fr}}
    </style>
</head>
<body class="mode-guild">

    <header>
        <div class="brand">ä½©æ¾¤æ‹‰å…‹å†’éšªè€…å…¬æœƒ</div>
        <div class="mode-switch">
            <button class="mode-btn active" onclick="switchMode('guild')">ğŸ›ï¸ å…¬æœƒå¤§å»³</button>
            <button class="mode-btn" onclick="switchMode('private')">ğŸ•¯ï¸ å€‹äººæ›¸æˆ¿</button>
        </div>
        <div id="user-status" style="display:none; font-size:0.9rem;">
            <span id="current-user" style="color:var(--highlight); margin-right:10px;"></span> 
            <button class="btn-logout" onclick="handleLogout()">ç™»å‡º</button>
        </div>
    </header>

    <div id="login-gate">
        <div id="login-view">
            <h2>ğŸ›¡ï¸ å†’éšªè€…èªè­‰</h2>
            <input type="text" class="game-input" id="login-name" placeholder="ä»£è™Ÿ">
            <input type="password" class="game-input" id="login-pass" placeholder="è­‰è™Ÿ">
            <button class="btn-action" onclick="handleLogin()">é€²å…¥ç³»çµ±</button>
            <p style="margin-top:15px; font-size:0.8rem; color:#888; cursor:pointer;" onclick="toggleReg(true)">æ–°é€²äººå“¡ç™»è¨˜</p>
        </div>
        <div id="reg-view" class="hidden">
            <h2 style="color:var(--highlight)">ğŸ“ æ–°é€²äººå“¡ç™»è¨˜</h2>
            <p style="color:#ccc; font-size:0.9rem; margin-bottom:15px; line-height:1.5;">
                è¨­å®šçš„ã€Œæš±ç¨±ã€å³ç‚ºç©å®¶IDã€‚<br>
                <span style="color:#ff6f00;">âš ï¸ å¯†ç¢¼ (è­‰è™Ÿ) å°‡è‡ªå‹•ç”Ÿæˆï¼Œè«‹å‹™å¿…è‡ªè¡Œè¨˜ä¸‹ã€‚</span>
            </p>
            <input type="text" class="game-input" id="reg-name" placeholder="è¨­å®šæš±ç¨±">
            <button class="btn-action" onclick="handleRegistration()">è¨»å†Šä¸¦å–å¾—è­‰è™Ÿ</button>
            <p style="margin-top:15px; font-size:0.8rem; color:#888; cursor:pointer;" onclick="toggleReg(false)">è¿”å›ç™»å…¥</p>
        </div>
    </div>

    <div id="npc-intro-layer" onclick="dismissIntro()">
        <img src="https://nlhqslyecdmwqdrtluki.supabase.co/storage/v1/object/public/NPC/npc-Itotia.webp" class="npc-full-body" alt="Itotia">
        <div class="npc-dialogue-ui">
            <div class="npc-label">ä¼Šæ‰˜è’‚é›…</div>
            <div class="typewriter-text" id="intro-text"></div>
        </div>
    </div>

    <div id="chat-widget">
        <div id="chat-box">
            <div class="chat-header">
                <img src="https://nlhqslyecdmwqdrtluki.supabase.co/storage/v1/object/public/NPC/Itotiatoken(1).webp">
                <span>ä¼Šæ‰˜è’‚é›…ï¼šæœ‰ä»€éº¼æˆ‘å¯ä»¥å¹«å¿™å‚³é”çš„å—ï¼Ÿ</span>
                <span onclick="toggleChat()" style="margin-left:auto; cursor:pointer;">Ã—</span>
            </div>
            <div class="chat-body" id="chat-msgs">
                <div class="chat-msg msg-npc">æ­¡è¿ä¾†åˆ°å…¬æœƒé€šè¨Šé »é“ï¼Œè«‹ä¿æŒç¦®è²Œã€‚</div>
            </div>
            <div class="chat-footer">
                <select id="chat-char-select" class="game-input" style="margin-bottom:5px; font-size:0.8rem; padding:4px;"><option value="">(ä½¿ç”¨ç©å®¶èº«åˆ†)</option></select>
                <div class="chat-input-row">
                    <input id="chat-in" placeholder="è¼¸å…¥è¨Šæ¯...">
                    <button id="chat-send" onclick="sendChat()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
        <div id="npc-chat-toggle" onclick="toggleChat()">
            <img id="npc-chat-img" src="https://nlhqslyecdmwqdrtluki.supabase.co/storage/v1/object/public/NPC/Itotiatoken(1).webp">
            <div id="chat-notify"></div>
        </div>
    </div>

    <div id="view-guild" class="view-container active">
        <div class="reception-area">
             <div style="text-align:center; color:var(--text-sub); font-family:var(--font-hand); font-style:italic;">
                "æ­¡è¿ä¾†åˆ°ä½©æ¾¤æ‹‰å…‹å†’éšªè€…å…¬æœƒã€‚è«‹éš¨æ„æŸ¥çœ‹ä½ˆå‘Šæ¬„ï¼Œæœ‰äº‹è«‹è©¢å•æ«ƒæª¯äººå“¡ã€‚"
            </div>
        </div>

        <nav class="nav-container">
            <button class="nav-btn active" onclick="showSection('notices','guild')"><span>å…¬å‘Š</span></button>
            <button class="nav-btn" onclick="showSection('quests','guild')"><span>ä»»å‹™</span></button>
            <button class="nav-btn" onclick="showSection('market','guild')"><span>å¸‚é›†</span></button>
            <button class="nav-btn" onclick="showSection('roster','guild')"><span>åå†Š</span></button>
            <button class="nav-btn" onclick="showSection('library','guild')"><span>æ›¸åº«</span></button>
        </nav>
        <main>
            <div id="notices" class="section active"><h2>å…¬æœƒå…¬å‘Š</h2><div class="card-grid" id="notice-list"></div></div>
            <div id="quests" class="section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2>æ‡¸è³å§”è¨—</h2>
                    <button class="btn-action" style="width:auto; margin:0;" onclick="openQuestModal()">+ ç™¼å¸ƒ</button>
                </div>
                <div class="card-grid" id="quest-list"></div>
            </div>
            <div id="market" class="section"><h2>äº¤æ˜“åœ“æ¡Œ</h2><div style="text-align:right; margin-bottom:10px;"><button class="btn-action" style="width:auto;" onclick="openListingModal()">+ ä¸Šæ¶</button></div><div class="card-grid" id="market-list"></div></div>
            <div id="roster" class="section">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <h2>å†’éšªè€…åå†Š (éšŠä¼)</h2>
                    <button class="btn-action" style="width:auto; margin:0;" onclick="openCreatePartyModal()">+ æˆç«‹æˆ°éšŠ</button>
                </div>
                <div class="roster-grid" id="roster-list"></div>
            </div>
            
            <div id="library" class="section">
                <div id="library-iframe-wrapper">
                    <iframe 
                        id="library-iframe" 
                        src="library.html" 
                        title="å…¬æœƒæ›¸åº«" 
                        onload="this.style.height=this.contentWindow.document.body.scrollHeight + 'px';" 
                        style="width: 100%; border: none; min-height: 80vh;">
                    </iframe>
                </div>
            </div>
            
        </main>
    </div>

    <div id="view-private" class="view-container">
        <div class="controls-wrapper">
            <div class="theme-bar">
                <div class="theme-btn t-scholar" onclick="setTheme('scholar')" title="å­¸è€…æ›¸æˆ¿"><i class="fas fa-feather-alt"></i></div>
                <div class="theme-btn t-warrior" onclick="setTheme('warrior')" title="æˆ°å£«åœ°çª–"><i class="fas fa-shield-alt"></i></div>
                <div class="theme-btn t-jungle" onclick="setTheme('jungle')" title="å¢æ—æ¨¹å±‹"><i class="fas fa-tree"></i></div>
                <div class="theme-btn t-tavern" onclick="setTheme('tavern')" title="æº«æš–é…’é¤¨"><i class="fas fa-beer"></i></div>
            </div>
            <div style="width:1px; height:20px; background:rgba(255,255,255,0.2);"></div>
            <nav class="nav-container">
                <button class="nav-btn active" onclick="showSection('my-chars','private')"><span>è§’è‰²è³‡æ–™</span></button>
                <button class="nav-btn" onclick="showSection('my-journal','private')"><span>å€‹äººæ—¥èªŒ</span></button>
            </nav>
        </div>
        <main>
            <div id="my-chars" class="section active">
                <div class="forge-wrapper">
                    <div class="char-list-sidebar">
                        <div class="char-list-header">æˆ‘çš„è§’è‰²</div>
                        <div class="char-list-content" id="char-list-items"></div>
                        <button class="btn-new-char" onclick="createNewChar()">+ å‰µå»º</button>
                    </div>
                    <div class="editor-main">
                        <div class="json-zone" onclick="document.getElementById('sheet-upload').click()">ğŸ“‚ ä¸Šå‚³ FVTT JSON<input type="file" id="sheet-upload" accept=".json" style="display:none" onchange="loadJsonToEditor(this)"></div>
                        
                        <div class="editor-layout">
                            <div class="editor-left">
                                <label class="editor-label">é ­åƒ (é»æ“Šæ›´æ›)</label>
                                <input type="file" id="avatar-file" accept="image/*" style="display:none" onchange="uploadAvatar(this)">
                                <div class="avatar-upload-wrapper" onclick="document.getElementById('avatar-file').click()">
                                    <img id="avatar-preview" class="avatar-img" src="">
                                    <div class="avatar-overlay"><i class="fas fa-camera"></i></div>
                                </div>
                                <input type="hidden" id="edit-avatar">
                                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
                                    <div><label class="editor-label">HP</label><input type="number" class="game-input" id="edit-hp"></div>
                                    <div><label class="editor-label">WP</label><input type="number" class="game-input" id="edit-wp"></div>
                                </div>
                                <div class="currency-row">
                                    <div class="curr-box"><div class="curr-label">Gold</div><input class="curr-input c-gold" style="color:#ffd700;" id="curr-gc" value="0"></div>
                                    <div class="curr-box"><div class="curr-label">Silver</div><input class="curr-input c-silver" style="color:#e0e0e0;" id="curr-sc" value="0"></div>
                                    <div class="curr-box"><div class="curr-label">Copper</div><input class="curr-input c-copper" style="color:#cd7f32;" id="curr-cc" value="0"></div>
                                </div>
                            </div>
                            <div class="editor-right">
                                <input type="hidden" id="edit-char-id">
                                <div style="display:flex; gap:10px;">
                                    <div style="flex:1"><label class="editor-label">å§“å</label><input class="game-input" id="edit-name"></div>
                                    <div style="flex:1"><label class="editor-label">ç¨®æ—</label><input class="game-input" id="edit-race"></div>
                                    <div style="flex:1"><label class="editor-label">è·æ¥­</label><input class="game-input" id="edit-class"></div>
                                    <div style="flex:0 0 80px"><label class="editor-label">è³‡æ­·</label><input type="number" class="game-input" id="edit-rank" placeholder="0"></div>
                                </div>
                                <div style="margin-top:10px;">
                                    <label class="editor-label">æ‰€å±¬æˆ°éšŠ (Party)</label>
                                    <input class="game-input" id="edit-party" placeholder="å¡«å¯«å·²è¨»å†Šçš„éšŠåï¼Œä¾‹å¦‚ï¼šé»‘æ›œåˆ©ç‰™">
                                </div>
                                
                                <div class="editor-tabs" style="margin-top:15px;">
                                    <button class="editor-tab active" onclick="switchEditorTab(event, 'edit-tab-core')">æ ¸å¿ƒ</button>
                                    <button class="editor-tab" onclick="switchEditorTab(event, 'edit-tab-skills')">æŠ€èƒ½</button>
                                    <button class="editor-tab" onclick="switchEditorTab(event, 'edit-tab-magic')">é­”æ³•</button>
                                    <button class="editor-tab" onclick="switchEditorTab(event, 'edit-tab-inv')">è£å‚™</button>
                                    <button class="editor-tab" onclick="switchEditorTab(event, 'edit-tab-bio')">å‚³è¨˜</button>
                                </div>

                                <div id="edit-tab-core" class="editor-panel active">
                                    <div class="editor-section">
                                        <label class="editor-label">åŸºç¤å±¬æ€§</label>
                                        <div class="attr-hex-grid">
                                            <div class="attr-hex"><label>STR</label><input class="game-input" id="attr-str"></div>
                                            <div class="attr-hex"><label>CON</label><input class="game-input" id="attr-con"></div>
                                            <div class="attr-hex"><label>AGL</label><input class="game-input" id="attr-agl"></div>
                                            <div class="attr-hex"><label>INT</label><input class="game-input" id="attr-int"></div>
                                            <div class="attr-hex"><label>WIL</label><input class="game-input" id="attr-wil"></div>
                                            <div class="attr-hex"><label>CHA</label><input class="game-input" id="attr-cha"></div>
                                        </div>
                                    </div>
                                    <div class="editor-section">
                                        <label class="editor-label">æ—è£”èƒ½åŠ›</label>
                                        <div id="kin-abilities-container" class="editor-list-box"></div>
                                        <button class="btn-add" onclick="addEditorItem('feature', 'kin')">+ æ–°å¢</button>
                                    </div>
                                    <div class="editor-section">
                                        <label class="editor-label">è‹±é›„èƒ½åŠ›</label>
                                        <div id="heroic-abilities-container" class="editor-list-box"></div>
                                        <button class="btn-add" onclick="addEditorItem('ability', 'heroic')">+ æ–°å¢</button>
                                    </div>
                                </div>

                                <div id="edit-tab-skills" class="editor-panel">
                                    <div class="editor-section">
                                        <label class="editor-label">ä¸»è¦æŠ€èƒ½</label>
                                        <div id="skills-core-container" class="editor-list-box"></div>
                                        <button class="btn-add" onclick="addEditorItem('skill','core')">+ æ–°å¢</button>
                                    </div>
                                    <div class="editor-section">
                                        <label class="editor-label">æ­¦å™¨æŠ€èƒ½</label>
                                        <div id="skills-weapon-container" class="editor-list-box"></div>
                                        <button class="btn-add" onclick="addEditorItem('skill','weapon')">+ æ–°å¢</button>
                                    </div>
                                    <div class="editor-section">
                                        <label class="editor-label">æ¬¡è¦æŠ€èƒ½</label>
                                        <div id="skills-secondary-container" class="editor-list-box"></div>
                                        <button class="btn-add" onclick="addEditorItem('skill','secondary')">+ æ–°å¢</button>
                                    </div>
                                </div>

                                <div id="edit-tab-magic" class="editor-panel">
                                    <div class="editor-section">
                                        <label class="editor-label">æˆ²æ³•</label>
                                        <div id="spells-cantrip-container" class="editor-list-box"></div>
                                        <button class="btn-add" onclick="addEditorItem('spell','cantrip')">+ æ–°å¢</button>
                                    </div>
                                    <div class="editor-section">
                                        <label class="editor-label">ç’°éšæ³•è¡“</label>
                                        <div id="spells-ranked-container" class="editor-list-box"></div>
                                        <button class="btn-add" onclick="addEditorItem('spell','ranked')">+ æ–°å¢</button>
                                    </div>
                                </div>

                                <div id="edit-tab-inv" class="editor-panel">
                                    <div class="editor-section">
                                        <label class="editor-label">æ­¦å™¨</label>
                                        <div id="inv-weapon-container" class="editor-list-box"></div>
                                        <button class="btn-add" onclick="addEditorItem('item','weapon')">+ æ–°å¢</button>
                                    </div>
                                    <div class="editor-section">
                                        <label class="editor-label">è­·ç”²</label>
                                        <div id="inv-armor-container" class="editor-list-box"></div>
                                        <button class="btn-add" onclick="addEditorItem('item','armor')">+ æ–°å¢</button>
                                    </div>
                                    <div class="editor-section">
                                        <label class="editor-label">ç‰©è³‡</label>
                                        <div id="inv-gear-container" class="editor-list-box"></div>
                                        <button class="btn-add" onclick="addEditorItem('item','item')">+ æ–°å¢</button>
                                    </div>
                                </div>

                                <div id="edit-tab-bio" class="editor-panel">
                                    <div class="editor-section"><label class="editor-label">å¤–è§€</label><textarea id="edit-appearance" class="game-textarea" rows="3" placeholder="æè¿°è§’è‰²çš„å¤–è§€ç‰¹å¾µ..."></textarea></div>
                                    <div class="editor-section"><label class="editor-label">å¼±é»</label><textarea id="edit-weakness" class="game-textarea" rows="3" placeholder="è§’è‰²çš„å¼±é»æˆ–ç¼ºé™·..."></textarea></div>
                                    <div class="editor-section"><label class="editor-label">å‚³è¨˜</label><textarea id="edit-bio" class="game-textarea" rows="8" placeholder="è§’è‰²çš„èƒŒæ™¯æ•…äº‹..."></textarea></div>
                                </div>
                                
                                <div style="display:flex; gap:10px; margin-top:20px; border-top:1px solid var(--border-color); padding-top:15px;">
                                    <button class="btn-action" onclick="saveCharacterSheet()">ğŸ’¾ ä¿å­˜è§’è‰²</button>
                                    <button class="btn-action" style="background:#8a0303;" onclick="deleteCharacter()">ğŸ—‘ï¸ åˆªé™¤</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="my-journal" class="section">
                <h2>æˆ‘çš„æ—¥èªŒ</h2>
                <div style="text-align:right; margin-bottom:10px;"><button class="btn-action" style="width:auto;" onclick="openJournalModal()">+ å¯«æ—¥èªŒ</button></div>
                <div class="card-grid" id="my-journal-list"></div>
            </div>
        </main>
    </div>

    <div id="quest-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" style="max-width:500px;">
            <span class="close-btn" onclick="closeModal(event)">Ã—</span>
            <h2>ç™¼å¸ƒæ‡¸è³</h2>
            <form onsubmit="handleQuestPost(event)">
                <div style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px; margin-bottom:15px;">
                    <label class="editor-label" style="margin-top:0;">å§”è¨—äºº (ç™¼å¸ƒå‰è«‹å…ˆè·Ÿæ«ƒå°äººå“¡ç¢ºèª)</label>
                    <div style="display:flex; gap:10px;">
                        <input id="q-client-name" class="game-input" placeholder="åç¨±">
                        <input id="q-client-img" class="game-input" placeholder="é ­åƒç¶²å€">
                    </div>
                </div>
                <label class="editor-label">ä»»å‹™å…§å®¹</label>
                <input id="q-title" class="game-input" placeholder="æ¨™é¡Œ" required style="margin-bottom:10px;">
                <textarea id="q-desc" class="game-textarea" rows="4" placeholder="è©³ç´°èªªæ˜..." required style="margin-bottom:10px;"></textarea>
                <input id="q-reward" class="game-input" placeholder="å ±é…¬" required>
                <button class="btn-action">ç™¼å¸ƒä»»å‹™</button>
            </form>
        </div>
    </div>

    <div id="listing-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" style="max-width:400px;">
            <span class="close-btn" onclick="closeModal(event)">Ã—</span>
            <h2>äº¤æ˜“éœ€æ±‚</h2>
            <form onsubmit="postItem(event)">
                <label class="editor-label" style="margin-top:0;">å¼µè²¼è€…è§’è‰²</label>
                <select id="in-char" class="game-input" required></select>
                <label class="editor-label">ç‰©å“åç¨±</label>
                <input id="in-name" class="game-input" placeholder="ç‰©å“" required>
                <label class="editor-label">åƒ¹æ ¼ / éœ€æ±‚</label>
                <input id="in-price" class="game-input" placeholder="è³£åƒ¹" required>
                <label class="editor-label">ç‰©å“æè¿°</label>
                <textarea id="in-desc" class="game-textarea" rows="3" placeholder="èªªæ˜"></textarea>
                <button class="btn-action">ä¸Šæ¶</button>
            </form>
        </div>
    </div>
    
    <div id="journal-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" style="max-width:600px;">
            <span class="close-btn" onclick="closeModal(event)">Ã—</span>
            <h2>å†’éšªæ—¥èªŒ</h2>
            <form onsubmit="handleJournalPost(event)">
                <input type="hidden" id="j-edit-id"> 
                <div style="display:flex; gap:10px;"><select id="j-char" class="game-input" style="flex:1"><option value="">-- ç„¡ --</option></select><input type="date" id="j-date" class="game-input" style="flex:1" required></div>
                <input id="j-title" class="game-input" placeholder="æ¨™é¡Œ" style="margin-top:10px;" required>
                <div id="j-adv-section" style="background:rgba(255,255,255,0.05); padding:10px; border-radius:4px; margin:10px 0; border:1px dashed #666;">
                    <label class="editor-label" style="margin-top:0;">æŠ€èƒ½æˆé•· (å¡« +1 è‡ªå‹•å‡ç´š)</label>
                    <div id="j-adv-container"></div>
                    <button type="button" class="btn-add" onclick="addJournalAdvancement()">+ æ–°å¢</button>
                </div>
                <textarea id="j-summary" class="game-textarea" rows="2" placeholder="å‚™è¨»" style="margin-top:10px;"></textarea>
                <textarea id="j-content" class="game-textarea" rows="5" placeholder="å…§å®¹" style="margin-top:10px;" required></textarea>
                <div style="display:flex; justify-content:space-between; margin-top:15px;">
                    <button class="btn-action" style="background:#8a0303; width:auto; display:none;" id="btn-delete-journal" type="button" onclick="deleteJournal()">ğŸ—‘ï¸ åˆªé™¤</button>
                    <button class="btn-action" style="width:auto;">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <div id="create-party-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" style="max-width:400px;">
            <span class="close-btn" onclick="closeModal(event)">Ã—</span>
            <h2>æˆç«‹æˆ°éšŠ</h2>
            <form onsubmit="handleCreateParty(event)">
                <label class="editor-label">æˆ°éšŠå¾½ç«  (æª”æ¡ˆä¸Šå‚³)</label>
                <input type="file" id="party-icon-upload" accept="image/png, image/jpeg, image/webp" style="margin-bottom: 10px;">
                <div id="icon-preview-container" style="margin-top: 10px; display: none; text-align: center; margin-bottom: 15px;">
                    <img id="icon-preview" src="#" alt="éšŠå¾½é è¦½" style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid var(--highlight);">
                    <p id="icon-upload-status" style="font-size: 0.8rem; color: #888; margin-top: 5px;">ç­‰å¾…ä¸Šå‚³...</p>
                </div>
                <label class="editor-label">æˆ°éšŠåç¨±</label>
                <input id="p-name" class="game-input" placeholder="ä¾‹å¦‚: é»‘æ›œåˆ©ç‰™" required style="margin-bottom:10px;">
                <label class="editor-label">å®£è¨€ / ç°¡ä»‹</label>
                <textarea id="p-desc" class="game-textarea" rows="3" placeholder="æˆ‘å€‘æ˜¯..."></textarea>
                <button class="btn-action">è¨»å†Šæˆ°éšŠ</button>
            </form>
        </div>
    </div>

    <div id="party-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" style="max-width:500px;">
            <span class="close-btn" onclick="closeModal(event)">Ã—</span>
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:15px; border-bottom:1px solid #444; padding-bottom:10px;">
                 <img id="party-modal-icon" src="" style="width:200px; height:200px; object-fit:cover; border-radius:50%; border:2px solid var(--highlight); display:none;">
                 <div>
                    <h2 id="party-modal-title" style="color:var(--highlight); margin:0;">éšŠä¼è©³æƒ…</h2>
                    <div id="party-modal-desc" style="color:#aaa; font-size:0.9rem; font-style:italic;"></div>
                 </div>
             </div>
            <div id="party-modal-list" class="char-list-modal"></div>
        </div>
    </div>

    <div id="comments-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal-content" style="max-width:500px;">
            <span class="close-btn" onclick="closeModal(event)">Ã—</span>
            <h2 id="comments-title">äº¤æ˜“ç•™è¨€</h2>
            <div id="comments-list" style="max-height:300px; overflow-y:auto; margin-bottom:15px; border:1px solid #444; padding:10px; background:rgba(0,0,0,0.3);"></div>
            <div style="display:flex; gap:5px; align-items:center;">
                <img id="comment-char-avatar" src="https://cdn-icons-png.flaticon.com/512/847/847969.png" style="width:35px; height:35px; border-radius:50%; object-fit:cover; border:1px solid #777;">
                <select id="comment-char-select" class="game-input" style="flex:1" onchange="updateCommentAvatar()">
                    <option value="">(ä½¿ç”¨ç©å®¶æœ¬å¸³)</option>
                </select>
                <input id="comment-in" class="game-input" style="flex:2" placeholder="è¼¸å…¥ç•™è¨€...">
                <button class="btn-action" style="width:auto; margin:0;" onclick="postComment()">ç™¼é€</button>
            </div>
            <input type="hidden" id="current-market-id">
        </div>
    </div>

    <div id="item-detail-modal" class="modal-overlay" onclick="closeModal(event)"><div class="modal-content" style="max-width:500px;"><span class="close-btn" onclick="closeModal(event)">Ã—</span><div id="item-detail-body"></div></div></div>
    <div id="toast">Msg</div>

    <script>
        const SUPABASE_URL = 'https://nlhqslyecdmwqdrtluki.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5saHFzbHllY2Rtd3FkcnRsdWtpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyMjM4NjAsImV4cCI6MjA3OTc5OTg2MH0.YlCfxdNP_aQh5Vge-dj079l2hdPeLzzAU0crGGU7XkM'; 
        const db = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const DEFAULT_AVATAR = "https://cdn-icons-png.flaticon.com/512/847/847969.png"; 

        // V67.0: Last Read Time for Chat
        let lastReadTime = new Date().toISOString(); 
        let isChatOpen = false;

        const THEMES = {
            'scholar': { bg: "url('https://nlhqslyecdmwqdrtluki.supabase.co/storage/v1/object/public/BG/001.webp'), radial-gradient(circle at 50% 10%, rgba(255, 160, 80, 0.15), rgba(0,0,0,0.8))", color: "#2c1e14", panel: "rgba(45, 30, 20, 0.95)", border: "#5d4037", hl: "#ffb74d", text: "#f3e5dc", sub: "#d7ccc8", in_bg: "#eaddcf", in_txt: "#3e2723", btn_bg: "linear-gradient(to bottom, #ffb74d, #e65100)", btn_txt: "#2e1500" },
            'warrior': { bg: "url('https://nlhqslyecdmwqdrtluki.supabase.co/storage/v1/object/public/BG/003.webp'), radial-gradient(circle at 50% 30%, #263238 0%, #000 100%)", color: "#000", panel: "rgba(30, 40, 45, 0.95)", border: "#78909c", hl: "#90a4ae", text: "#eceff1", sub: "#b0bec5", in_bg: "rgba(0,0,0,0.5)", in_txt: "#fff", btn_bg: "linear-gradient(to bottom, #90a4ae, #546e7a)", btn_txt: "#000" },
            'jungle': { bg: "url('https://nlhqslyecdmwqdrtluki.supabase.co/storage/v1/object/public/BG/002.webp'), radial-gradient(circle at 50% 20%, #1b5e20 0%, #000 90%)", color: "#051005", panel: "rgba(20, 35, 20, 0.95)", border: "#4caf50", hl: "#a5d6a7", text: "#e8f5e9", sub: "#c8e6c9", in_bg: "rgba(0,0,0,0.5)", in_txt: "#fff", btn_bg: "linear-gradient(to bottom, #a5d6a7, #388e3c)", btn_txt: "#000" },
            'tavern': { bg: "url('https://nlhqslyecdmwqdrtluki.supabase.co/storage/v1/object/public/BG/004.webp'), radial-gradient(circle at 50% 50%, #e65100 0%, #3e2723 100%)", color: "#2e1500", panel: "rgba(40, 20, 10, 0.95)", border: "#ff6f00", hl: "#ffcc80", text: "#fff3e0", sub: "#ffe0b2", in_bg: "rgba(0,0,0,0.5)", in_txt: "#fff", btn_bg: "linear-gradient(to bottom, #ffcc80, #ef6c00)", btn_txt: "#2e1500" }
        };

        let editorData = { kinAbilities: [], heroicAbilities: [], coreSkills: [], weaponSkills: [], secondarySkills: [], cantrips: [], rankedSpells: [], weapons: [], armors: [], gear: [] };
        let myCharacters = [];
        let globalRoster = [];
        let introPlayed = false;

        function switchMode(mode) {
            document.body.classList.remove('mode-guild', 'mode-private');
            document.body.classList.add(mode === 'guild' ? 'mode-guild' : 'mode-private');
            
            document.getElementById('view-guild').classList.toggle('active', mode === 'guild');
            document.getElementById('view-private').classList.toggle('active', mode === 'private');
            
            // Header buttons update
            document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
            const btnIndex = mode === 'guild' ? 0 : 1;
            document.querySelectorAll('.mode-btn')[btnIndex].classList.add('active');

            if(mode==='private') { const t = localStorage.getItem('maztica_theme') || 'scholar'; setTheme(t); loadMyCharactersList(); } 
            else { document.body.style.backgroundImage = ""; fetchData(); }
        }

        function setTheme(t) {
            const c = THEMES[t]; if(!c) return; document.body.style.backgroundImage = c.bg; const r = document.documentElement.style;
            r.setProperty('--p-bg-color', c.color); r.setProperty('--p-panel-bg', c.panel); r.setProperty('--p-border-color', c.border);
            r.setProperty('--p-highlight', c.hl); r.setProperty('--p-text-main', c.text); r.setProperty('--p-text-sub', c.sub); r.setProperty('--p-input-bg', c.in_bg);
            r.setProperty('--p-input-text', c.in_txt); r.setProperty('--p-btn-bg', c.btn_bg); r.setProperty('--p-btn-text', c.btn_txt);
            localStorage.setItem('maztica_theme', t); document.querySelectorAll('.theme-btn').forEach(b => b.classList.remove('active'));
            const btn = document.querySelector(`.t-${t}`); if(btn) btn.classList.add('active');
        }

        function showSection(id, mode) {
            const root = mode==='guild' ? 'view-guild' : 'view-private';
            document.getElementById(root).querySelectorAll('.section').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            const nav = document.getElementById(root).querySelector('.nav-container');
            nav.querySelectorAll('.nav-btn').forEach(b => { 
                b.classList.remove('active'); 
                if (b.getAttribute('onclick') && b.getAttribute('onclick').includes(id)) {
                    b.classList.add('active');
                } else if (id === 'library' && b.getAttribute('onclick') && b.getAttribute('onclick').includes('library.html')) {
                    if (b.innerText.includes('æ›¸åº«')) {
                        b.classList.add('active');
                    }
                }
            });
            if(id === 'library') {
                const iframe = document.getElementById('library-iframe');
                if (iframe.contentWindow.location.href !== iframe.src) {
                    iframe.src = iframe.src; 
                }
            }
        }

        function switchEditorTab(e, id) {
            document.querySelectorAll('.editor-panel').forEach(p => p.classList.remove('active')); 
            document.querySelectorAll('.editor-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active'); 
            e.currentTarget.classList.add('active');
        }

        function getRankTitle(r) {
            const rank = parseInt(r) || 0;
            if (rank <= 4) return `ğŸ¥‰ é»ƒéŠ…`;
            if (rank <= 9) return `ğŸª¨ é»‘æ›œçŸ³`;
            if (rank <= 14) return `â‡ï¸ ç¿ ç‰`;
            if (rank <= 19) return `ğŸ”± é»ƒé‡‘`;
            return `ğŸ’  ç¶ æ¾çŸ³`;
        }

        function setVal(id, v){const e=document.getElementById(id);if(e)e.value=v;}

        async function loadMyCharactersList(targetId = null) {
            const u = JSON.parse(localStorage.getItem('maztica_user')); if(!u) return;
            let { data: chars } = await db.from('my_characters').select('*').eq('owner_name', u.name).order('created_at', {ascending: true});
            myCharacters = chars || [];
            document.getElementById('char-list-items').innerHTML = myCharacters.map((c, i) => `<div class="char-list-item" onclick="selectCharacter(${i})">${c.name}</div>`).join('');
            
            const chatSel = document.getElementById('chat-char-select');
            const commSel = document.getElementById('comment-char-select');
            
            // Clear and Re-populate
            chatSel.innerHTML = '<option value="">(ä½¿ç”¨ç©å®¶èº«åˆ†)</option>';
            commSel.innerHTML = '<option value="">(ä½¿ç”¨ç©å®¶æœ¬å¸³)</option>';
            
            myCharacters.forEach(c => {
                const opt = new Option(c.name, c.id);
                chatSel.add(opt.cloneNode(true));
                commSel.add(opt);
            });

            if(myCharacters.length > 0) {
                 if(targetId) {
                     const idx = myCharacters.findIndex(c => c.id == targetId);
                     selectCharacter(idx >= 0 ? idx : 0);
                 } else {
                     // Don't auto-select character details on initial load to keep UI clean, 
                     // unless in private mode. But we can default to 0 index internally.
                 }
            } else {
                createNewChar();
            }

            let { data: logs } = await db.from('journals').select('*').eq('author_name', u.name).order('created_at',{ascending:false});
            document.getElementById('my-journal-list').innerHTML = logs.map(l => {
                let advHtml = (l.advancements && Array.isArray(l.advancements)) ? `<div style="margin-top:10px; padding:8px; background:rgba(0,0,0,0.1); border:1px dashed var(--border-color); border-radius:4px; font-size:0.85rem;"><div style="color:var(--text-sub); border-bottom:1px dashed var(--border-color); margin-bottom:4px;">æŠ€èƒ½æˆé•·</div>${l.advancements.map(a => `<div style="display:flex; justify-content:space-between;"><span>${a.skill}</span><span style="color:var(--highlight)">${a.note}</span></div>`).join('')}</div>` : '';
                return `<div class="card" onclick="editJournal('${l.id}')" style="cursor:pointer;"><div style="display:flex; justify-content:space-between; margin-bottom:5px;"><span class="tag" style="border-color:var(--highlight); color:var(--highlight)">${l.adventure_date || 'æœªçŸ¥æ—¥æœŸ'}</span><span class="tag">${myCharacters.find(c => c.id === l.character_id)?.name || 'æœªæŒ‡å®š'}</span></div><h3>${l.title}</h3>${l.summary ? `<div style="font-style:italic; color:var(--text-sub); margin-bottom:10px; padding-left:10px; border-left:3px solid #555;">${l.summary}</div>` : ''}<p class="desc">${l.content}</p>${advHtml}</div>`;
            }).join('');
        }

        async function editJournal(jid) {
            const { data } = await db.from('journals').select('*').eq('id', jid).single();
            if(!data) return;
            setVal('j-edit-id', data.id);
            setVal('j-title', data.title);
            setVal('j-date', data.adventure_date);
            setVal('j-summary', data.summary);
            setVal('j-content', data.content);
            const sel = document.getElementById('j-char');
            sel.innerHTML = '<option value="">-- ç„¡ --</option>'; 
            myCharacters.forEach(c => sel.add(new Option(c.name, c.id)));
            if(data.character_id) sel.value = data.character_id;
            
            document.getElementById('j-adv-container').innerHTML=''; 
            if(data.advancements) {
                data.advancements.forEach(adv => addJournalAdvancement(adv.skill, adv.note));
            }
            
            // Show Delete Button
            document.getElementById('btn-delete-journal').style.display = 'block';
            document.getElementById('journal-modal').classList.add('open');
        }

        async function deleteJournal() {
            const jid = document.getElementById('j-edit-id').value;
            if(!jid) return;
            if(confirm("ç¢ºå®šåˆªé™¤é€™ç¯‡æ—¥èªŒå—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚")) {
                await db.from('journals').delete().eq('id', jid);
                showToast("æ—¥èªŒå·²åˆªé™¤");
                document.getElementById('journal-modal').classList.remove('open');
                loadMyCharactersList();
            }
        }

        function openJournalModal(){ 
            const u = JSON.parse(localStorage.getItem('maztica_user')); 
            if(!u){alert('è«‹ç™»å…¥');return;} 
            document.getElementById('j-edit-id').value=''; 
            document.getElementById('j-title').value=''; 
            document.getElementById('j-content').value=''; 
            document.getElementById('j-summary').value='';
            const sel=document.getElementById('j-char'); 
            sel.innerHTML='<option value="">-- ç„¡ --</option>'; 
            myCharacters.forEach(c=>sel.add(new Option(c.name,c.id))); 
            document.getElementById('j-date').valueAsDate=new Date(); 
            document.getElementById('j-adv-container').innerHTML=''; 
            
            // Hide Delete Button for new entry
            document.getElementById('btn-delete-journal').style.display = 'none';
            document.getElementById('journal-modal').classList.add('open'); 
        }

        function selectCharacter(index) {
            if(index < 0 || !myCharacters[index]) return;
            document.querySelectorAll('.char-list-item').forEach((el, i) => el.classList.toggle('active', i === index));
            const char = myCharacters[index];
            setVal('edit-char-id', char.id); setVal('edit-name', char.name); setVal('edit-race', char.race); setVal('edit-class', char.class); setVal('edit-avatar', char.avatar_url); setVal('edit-rank', char.rank||0); setVal('edit-party', char.party||'');
            document.getElementById('avatar-preview').src = char.avatar_url;
            const sheet = char.sheet_data || {}; const sys = sheet.system || {}; const items = sheet.items || [];
            
            ['str','con','agl','int','wil','cha'].forEach(k => { 
                if(sys.attributes && sys.attributes[k]) {
                    const val = (sys.attributes[k].base !== undefined) ? sys.attributes[k].base : sys.attributes[k].value;
                    setVal(`attr-${k}`, val||10); 
                }
            });
            
            setVal('edit-hp', (sys.hitPoints ? (sys.hitPoints.max || sys.hitPoints.value) : 10)); 
            setVal('edit-wp', (sys.willPoints ? (sys.willPoints.max || sys.willPoints.value) : 10)); 
            
            setVal('edit-bio', (sys.notes||"").replace(/<[^>]*>?/gm, ''));
            setVal('edit-weakness', (sys.weakness||""));
            setVal('edit-appearance', (sys.appearance||""));

            if(sys.currency) { 
                setVal('curr-gc', sys.currency.gc||0); 
                setVal('curr-sc', sys.currency.sc||0); 
                setVal('curr-cc', sys.currency.cc||0); 
            }

            editorData.kinAbilities = items.filter(i => i.system.abilityType === 'kin');
            editorData.heroicAbilities = items.filter(i => i.system.abilityType === 'heroic');
            editorData.coreSkills = items.filter(i => i.type === 'skill' && i.system.skillType === 'core');
            editorData.weaponSkills = items.filter(i => i.type === 'skill' && i.system.skillType === 'weapon');
            editorData.secondarySkills = items.filter(i => i.type === 'skill' && i.system.skillType !== 'weapon' && i.system.skillType !== 'core');
            editorData.cantrips = items.filter(i => i.type === 'spell' && i.system.rank == 0);
            editorData.rankedSpells = items.filter(i => i.type === 'spell' && i.system.rank > 0);
            editorData.weapons = items.filter(i => i.type === 'weapon');
            editorData.armors = items.filter(i => ['armor','helmet'].includes(i.type));
            editorData.gear = items.filter(i => i.type === 'item');
            renderAllLists();
        }

        function createNewChar() {
            setVal('edit-char-id', ''); setVal('edit-name', 'æ–°è§’è‰²'); setVal('edit-race', ''); setVal('edit-class', ''); setVal('edit-avatar', ''); setVal('edit-rank', 0); setVal('edit-party', '');
            document.getElementById('avatar-preview').src = ""; ['str','con','agl','int','wil','cha'].forEach(k => setVal(`attr-${k}`, 10)); setVal('edit-hp', 10); setVal('edit-wp', 10); setVal('edit-bio', ''); setVal('edit-weakness', ''); setVal('edit-appearance', '');
            setVal('curr-gc', 0); setVal('curr-sc', 0); setVal('curr-cc', 0);
            editorData = { kinAbilities:[], heroicAbilities:[], coreSkills:[], weaponSkills:[], secondarySkills:[], cantrips:[], rankedSpells:[], weapons:[], armors:[], gear:[] };
            renderAllLists(); document.querySelectorAll('.char-list-item').forEach(el => el.classList.remove('active'));
        }
        
        function renderAllLists() { 
            renderBox('kin-abilities-container',editorData.kinAbilities,'kinAbilities'); 
            renderBox('heroic-abilities-container',editorData.heroicAbilities,'heroicAbilities'); 
            renderBox('skills-core-container',editorData.coreSkills,'coreSkills'); 
            renderBox('skills-weapon-container',editorData.weaponSkills,'weaponSkills'); 
            renderBox('skills-secondary-container',editorData.secondarySkills,'secondarySkills'); 
            renderBox('spells-cantrip-container',editorData.cantrips,'cantrips'); 
            renderBox('spells-ranked-container',editorData.rankedSpells,'rankedSpells'); 
            renderBox('inv-weapon-container',editorData.weapons,'weapons'); 
            renderBox('inv-armor-container',editorData.armors,'armors'); 
            renderBox('inv-gear-container',editorData.gear,'gear'); 
        }

        function renderBox(id, list, type) {
            document.getElementById(id).innerHTML = list.map((item, idx) => {
                const qty = item.system.quantity || 1;
                // V65.1: Only show quantity for equipment
                const showQty = ['weapons', 'armors', 'gear'].includes(type);
                // V65.1: Only show value/rank for skills (hide for features/spells)
                const showVal = ['coreSkills', 'weaponSkills', 'secondarySkills'].includes(type);
                
                let extraInput = '';
                if (showQty) extraInput = `<input type="number" value="${qty}" class="qty-input" onchange="updateEditorItem('${type}', ${idx}, 'qty', this.value)">`;
                else if (showVal) extraInput = `<input type="number" value="${item.system?.value || 0}" onchange="updateEditorItem('${type}', ${idx}, 'val', this.value)" style="width:50px;">`;
                
                return `<div class="item-row-edit"><input type="text" value="${item.name}" onchange="updateEditorItem('${type}', ${idx}, 'name', this.value)" style="flex:2;">${extraInput}<button class="btn-icon" onclick="removeEditorItem('${type}', ${idx})">âœ–</button></div>`;
            }).join('');
        }

        function updateEditorItem(t, i, k, v) {
            if (k === 'name') editorData[t][i].name = v;
            if (k === 'val') { if (!editorData[t][i].system) editorData[t][i].system = {}; editorData[t][i].system.value = v; }
            if (k === 'qty') { if (!editorData[t][i].system) editorData[t][i].system = {}; editorData[t][i].system.quantity = parseInt(v); }
        }

        function removeEditorItem(t, i) {
            editorData[t].splice(i, 1);
            renderAllLists();
        }

        function addEditorItem(b, s) {
            let t, n = { name: 'æ–°é …ç›®', type: b, system: { quantity: 1 } };
            if (b === 'feature') { n.system.abilityType = 'kin'; t = 'kinAbilities'; }
            else if (b === 'ability') { n.system.abilityType = 'heroic'; t = 'heroicAbilities'; }
            else if (b === 'skill') { n.system.skillType = s; t = s === 'core' ? 'coreSkills' : s === 'weapon' ? 'weaponSkills' : 'secondarySkills'; }
            else if (b === 'spell') { n.system.rank = s === 'cantrip' ? 0 : 1; t = s === 'cantrip' ? 'cantrips' : 'rankedSpells'; }
            else { n.type = s; t = s === 'weapon' ? 'weapons' : s === 'armor' ? 'armors' : 'gear'; }
            editorData[t].push(n);
            renderAllLists();
        }

        // --- SKILL CALCULATION LOGIC ---
        function getAttributeBase(val) {
            if(val <= 5) return 3;
            if(val <= 8) return 4;
            if(val <= 12) return 5;
            if(val <= 15) return 6;
            return 7; // 16-18
        }

 // â˜…â˜…â˜… ä¿®å¾©ï¼šåŠ å¼·ç‰ˆ JSON è®€å–é‚è¼¯ â˜…â˜…â˜…
function loadJsonToEditor(input) {
    const file = input.files[0]; if(!file) return;
    const r = new FileReader();
    
    r.onload = e => {
        try {
            const json = JSON.parse(e.target.result);
            console.log("Loading JSON:", json); // æ–¹ä¾¿é™¤éŒ¯ç”¨

            // 1. åŸºç¤è³‡æ–™
            setVal('edit-name', json.name || "æœªå‘½åè§’è‰²");
            
            // è™•ç†é ­åƒ (æœ‰äº› FVTT æ ¼å¼åœ–ç‰‡åœ¨ imgï¼Œæœ‰äº›åœ¨ prototypeToken.texture.src)
            let imgUrl = json.img || "";
            if (!imgUrl && json.prototypeToken && json.prototypeToken.texture) {
                imgUrl = json.prototypeToken.texture.src;
            }
            setVal('edit-avatar', imgUrl);
            document.getElementById('avatar-preview').src = imgUrl || DEFAULT_AVATAR;
            
            // 2. è‡ªå‹•åˆ¤æ–·ç¨®æ—èˆ‡è·æ¥­
            const items = json.items || [];
            const raceItem = items.find(i => i.type === 'kin' || i.type === 'race'); 
            if(raceItem) setVal('edit-race', raceItem.name);
            
            const classItem = items.find(i => i.type === 'profession' || i.type === 'class'); 
            if(classItem) setVal('edit-class', classItem.name);
            
            // 3. å±¬æ€§èˆ‡ç‹€æ…‹ (System Data)
            const sys = json.system || {};
            const attrs = sys.attributes || {};
            
            // è®€å–å…­å¤§å±¬æ€§
            ['str','con','agl','int','wil','cha'].forEach(k => { 
                if(attrs[k]) { 
                    // æœ‰äº›æ¨¡çµ„ç”¨ valueï¼Œæœ‰äº›ç”¨ base
                    const val = (attrs[k].base !== undefined) ? attrs[k].base : attrs[k].value; 
                    setVal(`attr-${k}`, val || 10); 
                } 
            });
            
            // â˜…â˜…â˜… HP/WP ä¿®å¾©é‡é» â˜…â˜…â˜…
            // å˜—è©¦å¤šç¨®å¸¸è¦‹è·¯å¾‘ï¼Œé¿å…è®€ä¸åˆ°
            let hp = 10, wp = 10;

            // æ‰¾ HP
            if (sys.hitPoints) hp = sys.hitPoints.value || sys.hitPoints.base;
            else if (attrs.hitPoints) hp = attrs.hitPoints.value || attrs.hitPoints.base;
            else if (sys.health) hp = sys.health.value || sys.health.base; // å…¶ä»–ç³»çµ±çš„å¸¸è¦‹æ¬„ä½

            // æ‰¾ WP
            if (sys.willPoints) wp = sys.willPoints.value || sys.willPoints.base;
            else if (attrs.willPoints) wp = attrs.willPoints.value || attrs.willPoints.base;
            else if (sys.power) wp = sys.power.value || sys.power.base; // å…¶ä»–ç³»çµ±çš„å¸¸è¦‹æ¬„ä½
            else if (sys.mana) wp = sys.mana.value || sys.mana.base;

            setVal('edit-hp', hp || 10);
            setVal('edit-wp', wp || 10);

            // éŒ¢å¹£
            if(sys.currency) {
                setVal('curr-gc', sys.currency.gc || 0);
                setVal('curr-sc', sys.currency.sc || 0);
                setVal('curr-cc', sys.currency.cc || 0);
            }

            // å‚³è¨˜é¡
            if(sys.notes) setVal('edit-bio', (sys.notes || "").replace(/<[^>]*>?/gm, ''));
            if(sys.weakness) setVal('edit-weakness', (sys.weakness || "").replace(/<[^>]*>?/gm, ''));
            if(sys.appearance) setVal('edit-appearance', (sys.appearance || "").replace(/<[^>]*>?/gm, ''));

            // 4. ç‰©å“èˆ‡æŠ€èƒ½éæ¿¾
            // è¼”åŠ©å‡½å¼ï¼šè¨ˆç®—æŠ€èƒ½åŸºç¤å€¼
            const getAttributeBase = (val) => {
                if(val <= 5) return 3; if(val <= 8) return 4; if(val <= 12) return 5; if(val <= 15) return 6; return 7;
            };

            const fixSkill = (s) => { 
                const attrKey = s.system.attribute; 
                // å¦‚æœæŠ€èƒ½æ•¸å€¼ç‚º 0ï¼Œå˜—è©¦è‡ªå‹•è¨ˆç®—åˆå§‹å€¼
                if((!s.system.value || s.system.value == 0) && attrKey && attrs[attrKey]) {
                    const attrVal = attrs[attrKey].value || attrs[attrKey].base;
                    const baseSkill = getAttributeBase(attrVal);
                    const isTrained = s.name.includes("å—è¨“"); 
                    s.system.value = isTrained ? baseSkill * 2 : baseSkill; 
                }
                return s; 
            };

            editorData.kinAbilities = items.filter(i => i.system.abilityType === 'kin');
            editorData.heroicAbilities = items.filter(i => i.system.abilityType === 'heroic');
            editorData.coreSkills = items.filter(i => i.type === 'skill' && i.system.skillType === 'core').map(fixSkill);
            editorData.weaponSkills = items.filter(i => i.type === 'skill' && i.system.skillType === 'weapon').map(fixSkill);
            editorData.secondarySkills = items.filter(i => i.type === 'skill' && i.system.skillType !== 'weapon' && i.system.skillType !== 'core').map(fixSkill);
            editorData.cantrips = items.filter(i => i.type === 'spell' && i.system.rank == 0);
            editorData.rankedSpells = items.filter(i => i.type === 'spell' && i.system.rank > 0);
            editorData.weapons = items.filter(i => i.type === 'weapon');
            editorData.armors = items.filter(i => ['armor','helmet'].includes(i.type));
            editorData.gear = items.filter(i => i.type === 'item');
            
            renderAllLists();
            showToast('âœ… JSON è³‡æ–™å·²åŒ¯å…¥');
        } catch(err) { 
            console.error(err);
            alert('JSON è§£æéŒ¯èª¤: '+err.message); 
        }
    };
    r.readAsText(file);
}

        async function showNPCIntro() {
            if(introPlayed) return; introPlayed = true;
            const overlay = document.getElementById('npc-intro-layer'); const textBox = document.getElementById('intro-text'); const u = JSON.parse(localStorage.getItem('maztica_user'));
            let nC = 0, qC = 0, mC = 0;
            try { const r1 = await db.from('notices').select('*', { count: 'exact', head: true }); nC = r1.count||0; const r2 = await db.from('quests').select('*', { count: 'exact', head: true }); qC = r2.count||0; const r3 = await db.from('market').select('*', { count: 'exact', head: true }); mC = r3.count||0; } catch(e) {}
            const text = `æ­¡è¿å›ä¾†ï¼Œ${u.name}ã€‚ä»Šå¤©å…¬æœƒä¹Ÿå¾ˆç†±é¬§å‘¢ã€‚\nç›®å‰æœ‰ ${nC} å‰‡é‡è¦å…¬å‘Šï¼Œ${qC} å€‹æ‡¸è³æ­£åœ¨æ‹›å‹Ÿå‹‡è€…ï¼Œå¸‚é›†è£¡ä¹Ÿæœ‰ ${mC} ä»¶äº¤æ˜“è«‹æ±‚ã€‚\nç¥æ‚¨æ­¦é‹æ˜Œéš†ï¼`;
            overlay.classList.add('active'); typeWriter(text, textBox, 0);
        }
        function typeWriter(text, element, i) { if (i < text.length) { element.innerHTML += text.charAt(i); setTimeout(() => typeWriter(text, element, i + 1), 30); } }
        function dismissIntro() { const overlay = document.getElementById('npc-intro-layer'); overlay.style.opacity = '0'; setTimeout(() => { overlay.classList.remove('active'); overlay.style.opacity = ''; document.getElementById('intro-text').innerHTML = ''; }, 500); }

        // --- FETCH & RENDER ---
        async function fetchData() {
            let registeredParties = []; try { let { data } = await db.from('parties').select('*'); registeredParties = data || []; } catch(e) {}
            const partyMap = {}; registeredParties.forEach(p => { partyMap[p.name] = p; });
            let { data: chars } = await db.from('my_characters').select('*').eq('is_public', true).order('created_at',{ascending:false});
            const parties = {}; registeredParties.forEach(p => { parties[p.name] = []; });
            (chars || []).forEach(c => { const pName = c.party || 'æœªç™»è¨˜éšŠä¼'; if (!parties[pName]) parties[pName] = []; parties[pName].push(c); });
            if(!parties['æœªç™»è¨˜éšŠä¼'] && chars && chars.some(c => !c.party)) { parties['æœªç™»è¨˜éšŠä¼'] = []; }
            document.getElementById('roster-list').innerHTML = Object.keys(parties).map(pName => {
                const members = parties[pName]; const regInfo = partyMap[pName]; const icon = regInfo ? regInfo.icon_url : 'https://cdn-icons-png.flaticon.com/512/32/32441.png'; const safePName = pName.replace(/'/g, "\\'"); const desc = regInfo ? regInfo.description : 'æ‹›å‹Ÿä¸­...'; 
                return `<div class="party-card" onclick="openPartyDetail('${safePName}')">${regInfo ? `<img src="${icon}" class="party-icon-img">` : `<div class="party-icon"><i class="fas fa-users"></i></div>`}<div class="party-name">${pName}</div><div class="party-slogan">${desc}</div><div class="party-count">${members.length} åæˆå“¡</div><div style="margin-top:10px; display:flex; justify-content:center; gap:5px;">${members.slice(0,4).map(m => `<img src="${m.avatar_url||DEFAULT_AVATAR}" class="member-preview-icon">`).join('')}${members.length > 4 ? '<span style="color:#888;">...</span>' : ''}</div></div>`;
            }).join('');
            window.currentParties = parties; window.partyMap = partyMap;

            let { data: n } = await db.from('notices').select('*'); document.getElementById('notice-list').innerHTML = n.map(x=>`<div class="card card-notice"><h3>${x.title}</h3><p class="desc">${x.content}</p></div>`).join('');
            
            // Quests with Status
            let { data: q } = await db.from('quests').select('*').order('created_at',{ascending:false}); 
            document.getElementById('quest-list').innerHTML = q.map(x=>{
                let statusClass = x.status === 'å·²å®Œæˆ' ? 'st-done' : (x.status === 'é€²è¡Œä¸­' ? 'st-taken' : 'st-open');
                let statusText = x.status || 'æœªæ¥å–';
                let taker = x.taken_by ? ` (${x.taken_by})` : '';
                return `<div class="card card-quest"><div class="quest-header"><img src="${x.client_avatar || DEFAULT_AVATAR}" class="quest-client-img"><span class="quest-client-name">${x.client_name || 'åŒ¿å'}</span><span class="status-tag ${statusClass}" style="margin-left:auto" onclick="toggleQuestStatus('${x.id}', '${statusText}')">${statusText}${taker}</span></div><div class="quest-body"><div class="quest-title">${x.title}</div><p class="quest-desc">${x.desc}</p></div><div class="quest-footer">å ±é…¬: ${x.reward}</div></div>`;
            }).join('');
            
            // Market with Comments
            let { data: m } = await db.from('market').select('*').order('created_at',{ascending:false}); 
            document.getElementById('market-list').innerHTML = m.map(x=>`<div class="card card-market"><div class="market-header"><img src="${x.seller_avatar || DEFAULT_AVATAR}" class="market-seller-img"><span class="market-seller-name">${x.owner}</span></div><div class="market-body"><div class="market-item">${x.item_name}</div><div class="market-desc">${x.description||''}</div></div><div class="market-footer">åƒ¹æ ¼: ${x.price}</div><button class="btn-action" style="font-size:0.8rem; margin:5px;" onclick="openComments('${x.id}')">ğŸ’¬ ç•™è¨€ / è©¢åƒ¹</button></div>`).join('');
        }

        async function toggleQuestStatus(qid, currentStatus) {
            const u = JSON.parse(localStorage.getItem('maztica_user'));
            const allowed = ['GM', 'NPC']; 
            if (!u || !allowed.includes(u.name)) {
                 alert("æ¬Šé™ä¸è¶³ï¼šåªæœ‰å…¬æœƒè¡Œæ”¿äººå“¡æ‰å¯è®Šæ›´ï¼");
                 return;
            }
            const newStatus = currentStatus.includes('æœªæ¥å–') ? 'é€²è¡Œä¸­' : (currentStatus.includes('é€²è¡Œä¸­') ? 'å·²å®Œæˆ' : 'æœªæ¥å–');
            let taker = '';
            if(newStatus === 'é€²è¡Œä¸­') taker = prompt("è«‹è¼¸å…¥æ¥å–ä»»å‹™çš„éšŠä¼åç¨±:");
            await db.from('quests').update({ status: newStatus, taken_by: taker }).eq('id', qid);
            fetchData();
        }

        // --- Comments Logic ---
        async function openComments(marketId) {
            document.getElementById('current-market-id').value = marketId;
            const { data } = await db.from('market_comments').select('*').eq('market_id', marketId).order('created_at');
            document.getElementById('comments-list').innerHTML = data ? data.map(c => `<div class="comment-row"><img src="${c.user_avatar||DEFAULT_AVATAR}" class="comment-avatar"><div><div class="comment-author">${c.user_name}</div><div class="comment-content">${c.content}</div></div></div>`).join('') : 'æš«ç„¡ç•™è¨€';
            document.getElementById('comments-modal').classList.add('open');
        }

        // V67.0: Dynamic Avatar Update Logic
        function updateCommentAvatar() {
            const sel = document.getElementById('comment-char-select');
            const img = document.getElementById('comment-char-avatar');
            const u = JSON.parse(localStorage.getItem('maztica_user'));
            
            if (sel.value) {
                const char = myCharacters.find(c => c.id == sel.value);
                img.src = char ? char.avatar_url : DEFAULT_AVATAR;
            } else {
                img.src = (u && u.avatar_url) ? u.avatar_url : DEFAULT_AVATAR; 
            }
        }

        async function postComment() {
            const u = JSON.parse(localStorage.getItem('maztica_user'));
            const mid = document.getElementById('current-market-id').value;
            const txt = document.getElementById('comment-in').value;
            const charId = document.getElementById('comment-char-select').value;
            let name = u.name, avatar = u.avatar_url || DEFAULT_AVATAR; 
            
            if(charId) {
                const char = myCharacters.find(c=>c.id==charId);
                if(char) { name = char.name; avatar = char.avatar_url; }
            }
            if(!txt) return;
            await db.from('market_comments').insert({ market_id: mid, user_name: name, user_avatar: avatar, content: txt });
            document.getElementById('comment-in').value = '';
            openComments(mid); // Reload
        }

        // --- MODAL & UI ---
        function openPartyDetail(pName) {
            const members = window.currentParties[pName];
            const regInfo = window.partyMap ? window.partyMap[pName] : null;
            const iconImg = document.getElementById('party-modal-icon');
            const descDiv = document.getElementById('party-modal-desc');
            if(regInfo && regInfo.icon_url) { iconImg.src = regInfo.icon_url; iconImg.style.display = 'block'; descDiv.innerText = regInfo.description || ''; } 
            else { iconImg.style.display = 'none'; descDiv.innerText = ''; }
            document.getElementById('party-modal-title').innerText = pName;
            document.getElementById('party-modal-list').innerHTML = members.length > 0 ? members.map(m => `<div class="char-row"><img src="${m.avatar_url||DEFAULT_AVATAR}"><div><div style="font-weight:bold; color:var(--highlight);">${m.name}</div><div style="font-size:0.8rem; color:#aaa;">${m.race} ${m.class} | <span style="color:#ffd700">${getRankTitle(m.rank)}</span> (${m.rank||0})</div></div></div>`).join('') : '<div style="text-align:center;">ç„¡æˆå“¡</div>';
            document.getElementById('party-modal').classList.add('open');
        }

        function openQuestModal() { const u=JSON.parse(localStorage.getItem('maztica_user')); if(!u){alert('è«‹ç™»å…¥');return;} setVal('q-client-name',u.name); setVal('q-client-img',u.avatar_url||''); document.getElementById('quest-modal').classList.add('open'); }
        async function handleQuestPost(e) { e.preventDefault(); await db.from('quests').insert({ title:document.getElementById('q-title').value, desc:document.getElementById('q-desc').value, reward:document.getElementById('q-reward').value, client_name:document.getElementById('q-client-name').value, client_avatar:document.getElementById('q-client-img').value, status: 'æœªæ¥å–' }); showToast("ç™¼å¸ƒæˆåŠŸ"); document.getElementById('quest-modal').classList.remove('open'); fetchData(); }

        function openCreatePartyModal() { const u=JSON.parse(localStorage.getItem('maztica_user')); if(!u){alert('è«‹ç™»å…¥');return;} document.getElementById('party-icon-upload').value=''; document.getElementById('icon-preview-container').style.display='none'; document.getElementById('create-party-modal').classList.add('open'); }
        
        async function uploadPartyIcon(file) {
            const u = JSON.parse(localStorage.getItem('maztica_user'));
            const filePath = `guild/${u.adventurer_id}/${Date.now()}_${file.name}`;
            document.getElementById('icon-upload-status').innerText = 'ä¸Šå‚³ä¸­...';
            const { error } = await db.storage.from('guild').upload(filePath, file, { upsert: false });
            if(error) { alert('Upload failed: '+error.message); return null; }
            const { data } = db.storage.from('guild').getPublicUrl(filePath);
            return data.publicUrl;
        }

        async function handleCreateParty(e) {
            e.preventDefault(); const u = JSON.parse(localStorage.getItem('maztica_user'));
            const file = document.getElementById('party-icon-upload').files[0];
            let url = '';
            if(file) { url = await uploadPartyIcon(file); if(!url) return; }
            const { error } = await db.from('parties').insert({ name: document.getElementById('p-name').value, description: document.getElementById('p-desc').value, leader_name: u.name, icon_url: url });
            if(error) alert(error.message); else { showToast("æˆ°éšŠå»ºç«‹æˆåŠŸ"); document.getElementById('create-party-modal').classList.remove('open'); fetchData(); }
        }

        function openListingModal(){ const u = JSON.parse(localStorage.getItem('maztica_user')); if(!u){alert('è«‹ç™»å…¥');return;} const sel=document.getElementById('in-char'); sel.innerHTML=''; myCharacters.forEach(c=>sel.add(new Option(c.name,c.id))); document.getElementById('listing-modal').classList.add('open'); }
        async function postItem(e){ e.preventDefault(); const u=JSON.parse(localStorage.getItem('maztica_user')); const charId=document.getElementById('in-char').value; const char=myCharacters.find(c=>c.id==charId); const name=char?char.name:u.name; const av=char?char.avatar_url:DEFAULT_AVATAR; await db.from('market').insert({item_name:document.getElementById('in-name').value, price:document.getElementById('in-price').value, description:document.getElementById('in-desc').value, owner:name, seller_avatar:av, type:'sell'}); showToast("ä¸Šæ¶æˆåŠŸ"); document.getElementById('listing-modal').classList.remove('open'); fetchData(); }

        function addJournalAdvancement(skill='', note='') {
            const div = document.createElement('div'); div.className = 'adv-row';
            let opts = '<option value="">-- é¸æ“‡æŠ€èƒ½ --</option>';
            const allSkills = [...editorData.coreSkills, ...editorData.weaponSkills, ...editorData.secondarySkills];
            allSkills.forEach(s => opts += `<option value="${s.name}" ${s.name===skill?'selected':''}>${s.name}</option>`);
            div.innerHTML = `<select class="adv-skill-sel game-input">${opts}</select><input class="adv-note-in game-input" placeholder="+1" value="${note}"><button type="button" class="btn-icon" onclick="this.parentElement.remove()">âœ–</button>`;
            document.getElementById('j-adv-container').appendChild(div);
        }

        async function handleJournalPost(e) {
    e.preventDefault(); 
    const u = JSON.parse(localStorage.getItem('maztica_user'));
    
    // å–å¾—æ—¥èªŒ IDï¼Œå¦‚æœæœ‰å€¼ä»£è¡¨æ˜¯ã€Œç·¨è¼¯æ¨¡å¼ã€ï¼Œæ²’å€¼ä»£è¡¨æ˜¯ã€Œæ–°å¢æ¨¡å¼ã€
    const jid = document.getElementById('j-edit-id').value;
    
    const payload = { 
        author_name: u.name, 
        title: document.getElementById('j-title').value, 
        content: document.getElementById('j-content').value, 
        summary: document.getElementById('j-summary').value, 
        adventure_date: document.getElementById('j-date').value, 
        character_id: document.getElementById('j-char').value || null
    };

// â˜…â˜…â˜… ä¿®å¾©ï¼šè£œä¸Šéºå¤±çš„åœ–ç‰‡ä¸Šå‚³å‡½å¼ â˜…â˜…â˜…
// ç¢ºä¿é€™å€‹å‡½å¼æ˜¯åœ¨å…¨åŸŸä½œç”¨åŸŸ
async function uploadAvatar(input) {
    const file = input.files[0];
    if (!file) return;

    const u = JSON.parse(localStorage.getItem('maztica_user'));
    if (!u) { alert("è«‹å…ˆç™»å…¥"); return; }

    const preview = document.getElementById('avatar-preview');
    const hiddenInput = document.getElementById('edit-avatar');
    
    preview.style.opacity = '0.5';
    showToast("æ­£åœ¨ä¸Šå‚³è‡³é ­åƒé¤¨...");

    try {
        const fileExt = file.name.split('.').pop().toLowerCase();
        const fileName = `${Date.now()}_${Math.random().toString(36).substr(2, 5)}.${fileExt}`;
        // ä¾ç…§ä½ çš„è¦æ±‚ï¼Œå­˜æ”¾åœ¨ 'avatar' å„²å­˜æ¡¶
        const filePath = `${u.adventurer_id}/${fileName}`; 

        // åŸ·è¡Œä¸Šå‚³
        const { data, error: uploadError } = await db.storage
            .from('avatar') 
            .upload(filePath, file, { 
                cacheControl: '3600',
                upsert: true,
                contentType: file.type 
            });

        if (uploadError) throw uploadError;

        // å–å¾—ç¶²å€ä¸¦æ›´æ–°
        const { data: urlData } = db.storage.from('avatar').getPublicUrl(filePath);
        const publicUrl = urlData.publicUrl;

        hiddenInput.value = publicUrl;
        preview.src = publicUrl;
        
        showToast("âœ… ä¸Šå‚³æˆåŠŸ");
        console.log("æ–°ç¶²å€å·²å¯«å…¥éš±è—æ¬„ä½:", publicUrl);

    } catch (err) {
        console.error("ä¸Šå‚³éç¨‹å‡ºéŒ¯:", err);
        alert(`ä¸Šå‚³å¤±æ•—ï¼š${err.message}`);
    } finally {
        preview.style.opacity = '1';
        input.value = ''; 
    }
}
    // æ”¶é›†æŠ€èƒ½æˆé•·æ¬„ä½
    const advs = [];
    document.querySelectorAll('.adv-row').forEach(r => {
        const s = r.querySelector('.adv-skill-sel').value; 
        const n = r.querySelector('.adv-note-in').value;
        if(s) advs.push({ skill: s, note: n });
    });
    payload.advancements = advs;

    // â˜…â˜…â˜… ä¿®å¾©æ ¸å¿ƒé‚è¼¯ â˜…â˜…â˜…
    // æ¢ä»¶ï¼š1. å¿…é ˆæ˜¯æ–°å¢æ¨¡å¼ (!jid) 2. å¿…é ˆæœ‰é¸è§’è‰² 3. å¿…é ˆæœ‰å¡«å¯«æˆé•·é …ç›®
    if(!jid && payload.character_id && advs.length > 0) {
        
        // æ­¥é©Ÿ 1: ç›´æ¥å¾è³‡æ–™åº«æŠ“å–è©²è§’è‰²æœ€æ–°çš„è³‡æ–™ï¼Œé¿å…ä½¿ç”¨ç¶²é æš«å­˜çš„èˆŠè³‡æ–™
        const { data: charData, error: charErr } = await db
            .from('my_characters')
            .select('*')
            .eq('id', payload.character_id)
            .single();

        if(charData && !charErr) {
            let updated = false;
            // å–å¾—æ·±å±¤è¤‡è£½çš„ sheet_dataï¼Œç¢ºä¿ä¿®æ”¹å®‰å…¨
            const sheet = charData.sheet_data; 

            advs.forEach(adv => {
                // æª¢æŸ¥ç­†è¨˜æ¬„ä½æ˜¯å¦åŒ…å« '+' è™Ÿæˆ–è€…æ˜¯æ•¸å­— (ä¾‹å¦‚ "+1" æˆ– "1")
                if(adv.note.includes('+') || !isNaN(adv.note)) {
                    // è§£ææ•¸å€¼ï¼šç§»é™¤ '+' è™Ÿå¾Œè½‰ç‚ºæ•´æ•¸
                    const inc = parseInt(adv.note.replace('+','')) || 0;
                    
                    // æ­¥é©Ÿ 2: åœ¨è§’è‰²çš„ items ä¸­å°‹æ‰¾åç¨±ç›¸ç¬¦çš„æŠ€èƒ½
                    if(sheet.items && Array.isArray(sheet.items)) {
                        // ä½¿ç”¨ trim() å»é™¤å¯èƒ½çš„ç©ºç™½ï¼Œå¢åŠ æ¯”å°æˆåŠŸç‡
                        const skillItem = sheet.items.find(i => i.name.trim() === adv.skill.trim());
                        
                        if(skillItem) {
                            // ç¢ºä¿ system ç‰©ä»¶å­˜åœ¨
                            if(!skillItem.system) skillItem.system = {};
                            
                            // æ­¥é©Ÿ 3: é€²è¡Œæ•¸å€¼è¨ˆç®— (å¼·åˆ¶è½‰ç‚º Int é¿å…å­—ä¸²ä¸²æ¥éŒ¯èª¤)
                            const currentVal = parseInt(skillItem.system.value) || 0;
                            skillItem.system.value = currentVal + inc;
                            
                            updated = true;
                            // å¯ä»¥åœ¨é€™è£¡åŠ å€‹ log æ–¹ä¾¿é™¤éŒ¯
                            console.log(`[ç³»çµ±] æŠ€èƒ½å‡ç´š: ${skillItem.name} å¾ ${currentVal} æå‡è‡³ ${skillItem.system.value}`);
                        }
                    }
                }
            });

            // æ­¥é©Ÿ 4: åªæœ‰åœ¨æ•¸å€¼çœŸçš„æœ‰è®Šå‹•æ™‚ï¼Œæ‰å¯«å›è³‡æ–™åº«
            if(updated) {
                const { error: updateError } = await db.from('my_characters')
                    .update({ sheet_data: sheet })
                    .eq('id', charData.id);
                
                if(!updateError) {
                    showToast(`âœ… è§’è‰² ${charData.name} çš„æŠ€èƒ½å·²è‡ªå‹•æ›´æ–°`);
                } else {
                    console.error("æ›´æ–°è§’è‰²å¤±æ•—:", updateError);
                }
            }
        }
    } else if (jid) {
        // é€™è£¡ç¢ºä¿äº†ç·¨è¼¯æ¨¡å¼ä¸‹ä¸æœƒè§¸ç™¼ä¸Šè¿°é‚è¼¯
        console.log("ç·¨è¼¯æ¨¡å¼ï¼šç•¥éæŠ€èƒ½è‡ªå‹•å‡ç´šæª¢æŸ¥");
    }

    // æœ€å¾ŒåŸ·è¡Œæ—¥èªŒæœ¬èº«çš„ æ–°å¢ æˆ– æ›´æ–°
    if(jid) await db.from('journals').update(payload).eq('id', jid);
    else await db.from('journals').insert(payload);
    
    showToast("æ—¥èªŒå·²ä¿å­˜...é‡æ–°è¼‰å…¥è§’è‰²æ‰æœƒæ›´æ–°ç•«é¢ä¸Šçš„æ•¸å€¼"); 
    document.getElementById('journal-modal').classList.remove('open'); 
    loadMyCharactersList(); // é‡æ–°è¼‰å…¥åˆ—è¡¨ä»¥æ›´æ–°ç•«é¢ä¸Šçš„æ•¸å€¼
}
        // --- CHAT LOGIC ---
        function toggleChat(){ 
            const b=document.getElementById('chat-box'); 
            const wasClosed = b.style.display !== 'flex';
            b.style.display = wasClosed ? 'flex' : 'none'; 
            isChatOpen = wasClosed;

            if(isChatOpen) {
                scrollChat(); 
                document.getElementById('chat-notify').style.display='none'; 
                // V66.0: Mark read on open
                lastReadTime = new Date().toISOString();
                localStorage.setItem('maztica_last_read', lastReadTime);
            }
        }

        async function sendChat(){
            const i=document.getElementById('chat-in'); const u=JSON.parse(localStorage.getItem('maztica_user')); 
            const charId = document.getElementById('chat-char-select').value;
            let name = u.name, avatar = null;
            if(charId) {
                const char = myCharacters.find(c => c.id == charId);
                if(char) { name = char.name; avatar = char.avatar_url; }
            }
            await db.from('messages').insert({user_name: name, content: i.value, avatar_url: avatar}); 
            i.value='';
        }
        function scrollChat(){const b=document.getElementById('chat-msgs'); b.scrollTop=b.scrollHeight;}

        function renderMsgElement(user, content, avatar, timeStr) {
           const u = JSON.parse(localStorage.getItem('maztica_user'));
           const div = document.createElement('div');
           const isMe = (u && user === u.name) || myCharacters.some(c => c.name === user); 
           div.className = 'chat-msg ' + (isMe ? 'msg-player' : 'msg-npc');
           const imgHTML = avatar ? `<img src="${avatar}" class="chat-avatar">` : '';
           const textHTML = `<div><div style="font-size:0.75rem; opacity:0.7">${user}</div>${content}</div>`;
           div.innerHTML = isMe ? (textHTML + imgHTML) : (imgHTML + textHTML);
           document.getElementById('chat-msgs').appendChild(div);
           scrollChat();

           // V66.0: Enhanced Notify Logic
           const box = document.getElementById('chat-box');
           // If chat is closed AND message is newer than last read
           if(box.style.display !== 'flex' && timeStr > lastReadTime) {
               document.getElementById('chat-notify').style.display = 'block';
           } else if (box.style.display === 'flex') {
               // Update read time if chat is open
               lastReadTime = new Date().toISOString();
               localStorage.setItem('maztica_last_read', lastReadTime);
           }
        }

        async function fetchMessages(){
            const { data } = await db.from('messages').select('*').order('created_at', { ascending: true }).limit(50);
            if (data) {
                // Clear and add static welcome first
                const box = document.getElementById('chat-msgs');
                box.innerHTML = '<div class="chat-msg msg-npc">æ­¡è¿ä¾†åˆ°å…¬æœƒé€šè¨Šé »é“ï¼Œè«‹ä¿æŒç¦®è²Œã€‚</div>';
                data.forEach(m => {
                    renderMsgElement(m.user_name, m.content, m.avatar_url, m.created_at);
                });
            }
        }

        function subChat(){
            db.channel('public:messages')
              .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, payload => {
                  renderMsgElement(payload.new.user_name, payload.new.content, payload.new.avatar_url, payload.new.created_at);
              })
              .subscribe();
        }
        
        async function saveCharacterSheet() { const u=JSON.parse(localStorage.getItem('maztica_user')); const cid=document.getElementById('edit-char-id').value; const all=[...editorData.kinAbilities,...editorData.heroicAbilities,...editorData.coreSkills,...editorData.weaponSkills,...editorData.secondarySkills,...editorData.cantrips,...editorData.rankedSpells,...editorData.weapons,...editorData.armors,...editorData.gear]; const sheet={name:document.getElementById('edit-name').value,img:document.getElementById('edit-avatar').value,system:{attributes:{str:{value:document.getElementById('attr-str').value},con:{value:document.getElementById('attr-con').value},agl:{value:document.getElementById('attr-agl').value},int:{value:document.getElementById('attr-int').value},wil:{value:document.getElementById('attr-wil').value},cha:{value:document.getElementById('attr-cha').value}},hitPoints:{value:document.getElementById('edit-hp').value,max:document.getElementById('edit-hp').value},willPoints:{value:document.getElementById('edit-wp').value,max:document.getElementById('edit-wp').value},currency:{gc:document.getElementById('curr-gc').value,sc:document.getElementById('curr-sc').value,cc:document.getElementById('curr-cc').value},notes:document.getElementById('edit-bio').value,weakness:document.getElementById('edit-weakness').value,appearance:document.getElementById('edit-appearance').value},items:all}; const payload={owner_name:u.name,name:sheet.name,race:document.getElementById('edit-race').value,class:document.getElementById('edit-class').value,avatar_url:sheet.img,rank:document.getElementById('edit-rank').value,sheet_data:sheet,party:document.getElementById('edit-party').value,is_public:true}; let tid=cid; if(cid) await db.from('my_characters').update(payload).eq('id',cid); else { const{data}=await db.from('my_characters').insert(payload).select(); if(data)tid=data[0].id; } showToast("ä¿å­˜æˆåŠŸ"); await loadMyCharactersList(tid); }
        function closeModal(e){if(e.target===e.currentTarget||e.target.classList.contains('close-btn')) e.target.closest('.modal-overlay').classList.remove('open');}
        function handleLogout(){localStorage.removeItem('maztica_user'); location.reload();}
        function showToast(m){ const t=document.getElementById('toast'); if(t){t.innerText=m;t.style.display='block';setTimeout(()=>t.style.display='none',3000);}else alert(m); }

        // â˜…â˜…â˜… RE-ADDED MISSING LOGIN FUNCTIONS â˜…â˜…â˜…
        async function handleLogin(){ 
            const n=document.getElementById('login-name').value; 
            const p=document.getElementById('login-pass').value; 
            // Using maybeSingle() to avoid error on no rows
            const {data, error} = await db.from('roster').select('*').eq('name',n).eq('password',p).maybeSingle(); 
            
            if(data){
                localStorage.setItem('maztica_user',JSON.stringify(data)); 
                enterGuild(data);
            } else {
                alert("ç™»å…¥å¤±æ•—ï¼šå¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤");
            } 
        }

        async function handleRegistration(){ 
            const n=document.getElementById('reg-name').value; 
            if(!n) return alert("è«‹è¼¸å…¥æš±ç¨±");
            const id="MZ-"+Math.floor(1000+Math.random()*9000); 
            const {error} = await db.from('roster').insert({
                name:n, 
                password:id, 
                adventurer_id:id, 
                rank:'é’éŠ…', 
                status:'æ–°é€²', 
                is_hidden:false
            }); 
            if(error) alert("è¨»å†Šå¤±æ•—: " + error.message);
            else {
                alert(`è¨»å†ŠæˆåŠŸ! æ‚¨çš„è­‰è™Ÿæ˜¯: ${id} (è«‹æˆªåœ–è¨˜ä¸‹)`); 
                location.reload(); 
            }
        }

        function enterGuild(u){ 
            document.body.classList.add('authenticated');
            document.getElementById('user-status').style.display='block'; 
            document.getElementById('current-user').innerText=u.name; 
            document.getElementById('view-guild').classList.add('active'); 
            fetchData(); 
            showNPCIntro(); 
            subChat(); 
            fetchMessages(); 

            // V68.0: Load characters on login so Market dropdowns work immediately
            loadMyCharactersList();
        }
        
        function checkSession(){
            const s=localStorage.getItem('maztica_user'); 
            // V66.0: Init last read
            lastReadTime = localStorage.getItem('maztica_last_read') || new Date(0).toISOString();
            if(s) { enterGuild(JSON.parse(s)); } 
            else { document.body.classList.remove('authenticated'); }
        }

        // â˜…â˜…â˜… CHAT ENTER KEY LISTENER â˜…â˜…â˜…
        window.onload = function() {
            checkSession();
            document.getElementById('chat-in').addEventListener('keypress', function (e) {
                if (e.key === 'Enter') { sendChat(); }
            });
            const iconUp = document.getElementById('party-icon-upload');
            if(iconUp) iconUp.addEventListener('change', function(e) {
                const f = e.target.files[0];
                if(f) {
                    const r = new FileReader();
                    r.onload = ev => { document.getElementById('icon-preview').src = ev.target.result; document.getElementById('icon-preview-container').style.display='block'; };
                    r.readAsDataURL(f);
                }
            });
        };
    </script>
</body>
</html>
